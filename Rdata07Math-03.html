<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŠ¤í„° íŠ¸ë˜ë¸” ë§µ ì—ë””í„° (Smart Align)</title>
    <style>
        // ì¤‘ë³µì€ ì œê±°
        /* [â˜… LaTeX ë„ì›€ë§ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ê°œì„ )] */
        #latexHelpModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            /* ë” ì–´ë‘ìš´ ë°°ê²½ */
            z-index: 10000;
            /* ì¼ë°˜ ëª¨ë‹¬ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            /* ë°°ê²½ì— ì€ì€í•œ ë¸”ëŸ¬ íš¨ê³¼ */
            transition: opacity 0.3s;
        }

        .latex-help-content {
            background-color: #f8f9fa;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            max-width: 950px;
            /* <--- ê°€ë¡œ ê¸¸ì´ í™•ì¥ (ê¸°ì¡´ 750px) */
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            /* <--- ì¢Œìš° ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            text-rendering: optimizeLegibility;
        }

        .latex-help-content h2 {
            color: #0056b3;
            /* ë©”ì¸ ìƒ‰ìƒ */
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
            margin-top: 0;
            font-weight: 700;
            font-size: 1.8em;
        }

        .latex-help-content h3 {
            color: #495057;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.3em;
            border-left: 4px solid #adb5bd;
            /* ì™¼ìª½ ì„¸ë¡œì¤„ë¡œ êµ¬ë¶„ */
            padding-left: 10px;
        }

        .latex-help-content ul {
            list-style-type: none;
            /* ê¸°ë³¸ ì  ì œê±° */
            padding-left: 0;
        }

        .latex-help-content li {
            margin-bottom: 10px;
            background-color: #ffffff;
            /* ë¦¬ìŠ¤íŠ¸ í•­ëª© ë°°ê²½ */
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            border: 1px solid #e9ecef;
        }

        .latex-help-content li strong {
            color: #007bff;
            min-width: 80px;
            /* ìš©ì–´ ê³ ì • ë„ˆë¹„ */
            margin-right: 15px;
            font-weight: 600;
        }

        /* ì½”ë“œ ë¸”ë¡ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .latex-help-content li code {
            font-family: Consolas, 'Courier New', monospace;
            /* ì½”ë“œ í°íŠ¸ ë³€ê²½ */
            font-size: 0.95em;
            background-color: #e9ecef;
            padding: 3px 6px;
            border-radius: 4px;
            color: #495057;
            /* <-- ì½”ë“œ ì…ë ¥ ìƒ‰ìƒì„ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ (ê¸°ì¡´ ë¹¨ê°„ìƒ‰ ê³„ì—´) */
            white-space: nowrap;
            overflow-x: auto;
        }

        /* MathJaxë¡œ ë Œë”ë§ëœ ìˆ˜ì‹ (span.mjx-chtml) ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        /* ë„ì›€ë§ ëª¨ë‹¬ ë‚´ì˜ ëª¨ë“  MathJax ë Œë”ë§ ê²°ê³¼ì— ì ìš©ë˜ì–´ ì„ ëª…í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. */
        .latex-help-content .mjx-chtml {
            color: #007bff;
            /* <-- ë Œë”ë§ëœ ìˆ˜ì‹ì„ íŒŒë€ìƒ‰(ë©”ì¸ ìƒ‰ìƒ)ìœ¼ë¡œ ì§€ì •í•˜ì—¬ ì„ ëª…í•˜ê²Œ ë§Œë“¦ */
            font-weight: 600;
            /* ìˆ˜ì‹ êµµê²Œ */
            font-size: 1.1em;
            /* ìˆ˜ì‹ í¬ê¸° ì•½ê°„ í‚¤ì›€ */
        }



        /* ì¶”ê°€ ë ˆì´ì•„ì›ƒ (ë‘ ì—´ ë°°ì¹˜) */
        .flex-columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            /* ì‘ì€ í™”ë©´ì—ì„œ ì¤„ ë°”ê¿ˆ í—ˆìš© */
        }

        .flex-columns>div {
            flex: 1;
            min-width: 300px;
        }

        .close-info {
            text-align: center;
            font-size: 1em;
            color: #6c757d;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px dashed #ced4da;
        }

        //ì¤‘ë³µì€ ì œê±° ë


        /* [ë ˆì´ì•„ì›ƒ] */
        html,
        body {
            font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
            background: #f0f0f0;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* [ìƒë‹¨ íˆ´ë°”] */
        .toolbar {
            padding: 8px;
            background: #f5f5f5;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            z-index: 10;
            height: auto;
            min-height: 40px;
        }

        /* [íƒ­ ì˜ì—­] */
        .tabs {
            display: flex;
            gap: 4px;
            background: #e8e8e8;
            padding: 0 10px;
            overflow-x: auto;
            overflow-y: hidden;
            height: 40px;
            align-items: flex-end;
            flex-shrink: 0;
            border-bottom: 1px solid #ccc;
        }

        .tab {
            padding: 0 20px;
            background: #d0d0d0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
            color: #555;
            transition: all 0.2s;
            margin-bottom: 0;
            border: 1px solid #ccc;
            border-bottom: none;
            height: 30px;
            display: flex;
            align-items: center;
        }

        .tab.active {
            background: #fff;
            font-weight: bold;
            color: #000;
            height: 35px;
            font-size: 15px;
            position: relative;
            z-index: 5;
            border-color: #ccc;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            box-shadow: 0 -2px 3px rgba(0, 0, 0, 0.05);
            cursor: default;
        }

        .tab:hover:not(.active) {
            background: #e0e0e0;
        }

        /* [ì‘ì—… ì˜ì—­] */
        .workspace {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 0;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            cursor: default;
        }

        .workspace.grab {
            cursor: grab;
        }

        .workspace.grabbing {
            cursor: grabbing;
        }

        .container {
            position: relative;
            border: 1px solid #ddd;
            margin: 0;
            width: calc(70vw * 1.414);
            height: 70vw;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
            background-color: #fff;
            flex-shrink: 0;
            transition: background-size 0.2s, background-position 0.2s;
        }

        /* [ë°•ìŠ¤ ê³µí†µ ìŠ¤íƒ€ì¼] */
        .box {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 2;
            display: flex;
            flex-wrap: wrap;
            /* <--- ì´ ì¤„ì„ ì¶”ê°€í•©ë‹ˆë‹¤. */
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
            overflow: hidden;
        }

        .box.normal {
            padding: 5px 10px;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 14px;
        }

        .box.dot {
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            padding: 0;
            font-size: 0;
            color: transparent;
        }

        .box.dot:hover {
            transform: scale(1.2);
            transition: transform 0.1s;
        }

        /* [ì„ íƒ ìŠ¤íƒ€ì¼ ê°œì„ ] */
        /* ê¸°ì¤€ ë°•ìŠ¤ (ì²«ë²ˆì§¸ ì„ íƒ) - ë¹¨ê°• */
        .box.selected.primary {
            outline: 3px solid #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            z-index: 10;
        }

        /* ì¶”ê°€ ë°•ìŠ¤ (ë‚˜ë¨¸ì§€) - íŒŒë‘ */
        .box.selected.secondary {
            outline: 2px solid #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
        }

        .group-rect {
            position: absolute;
            border: 2px dashed #999;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            pointer-events: none;
            z-index: 0;
            transition: all 0.1s ease;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            cursor: pointer;
            border: 1px solid #bbb;
            border-radius: 3px;
            transition: transform 0.1s;
            flex-shrink: 0;
        }

        .color-swatch:hover {
            transform: scale(1.2);
            border-color: #333;
            z-index: 10;
        }

        #palette {
            display: flex;
            gap: 2px;
            padding-left: 5px;
            align-items: center;
            flex-wrap: nowrap;
            overflow: visible;
            width: auto;
        }

        #paletteArea {
            display: flex;
            align-items: center;
            gap: 5px;
            border-left: 1px solid #ccc;
            padding-left: 10px;
            margin-left: 10px;
        }

        #paletteArea.hidden {
            display: none !important;
        }

        .linkLine {
            position: absolute;
            background: #333;
            height: 2px;
            transform-origin: 0 0;
            z-index: 1;
            cursor: pointer;
            opacity: 0.8;
        }

        .linkLine:hover {
            height: 4px;
            background: #0099ff;
        }

        .linkLine.arrow::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid #333;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .linkLine:hover.arrow::after {
            border-left-color: #0099ff;
        }

        .linkLine.red {
            background-color: #ff4d4d;
        }

        .linkLine.red::after {
            border-left-color: #ff4d4d;
        }

        .linkLine.red:hover {
            background-color: #ff8080;
        }

        .linkLine.red:hover::after {
            border-left-color: #ff8080;
        }

        .linkLine.blue {
            background-color: #007bff;
        }

        .linkLine.blue::after {
            border-left-color: #007bff;
        }

        .resizeHandle {
            width: 12px;
            height: 12px;
            position: absolute;
            bottom: 0;
            right: 0;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, #888 50%);
            z-index: 3;
        }

        .box.dot .resizeHandle {
            display: none;
        }

        /* ëª¨ë‹¬ ë° UI */
        #helpModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        #helpModalContent {
            background: #fff;
            padding: 30px;
            border-radius: 16px;
            width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        #closeHelp {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 24px;
            color: #888;
        }

        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .sep {
            width: 1px;
            height: 20px;
            background: #ccc;
            margin: 0 5px;
        }

        .btn-primary {
            color: #0044cc;
            font-weight: bold;
        }

        .btn-success {
            color: #007700;
            font-weight: bold;
        }

        .btn-dot {
            color: #cc0000;
            font-weight: bold;
            background-color: #fff0f0;
            border: 1px solid #ffcccc;
        }



        .auto-save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: transparent;
            /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ */
            color: #007bff !important;
            /* ê¸€ì”¨ ìƒ‰ìƒ: íŒŒë€ìƒ‰ */
            padding: 0;
            /* ì•ˆìª½ ì—¬ë°± ì œê±° */
            border-radius: 0;
            /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
            font-size: 14px;
            font-weight: normal;
            box-shadow: none;
            /* ë°•ìŠ¤ ê·¸ë¦¼ì ì œê±° */
            z-index: 9999;
            display: none;
            pointer-events: none;
        }



        .btn-align {
            padding: 2px 6px;
            font-size: 14px;
            min-width: 30px;
        }

        select {
            padding: 2px 4px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            max-width: 140px;
        }

        #currentFileName {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-right: 10px;
            background: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: none;
        }

        /* [â˜… ì¶”ê°€í•  ì½”ë“œ] ë„ì›€ë§ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #latexHelpModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            /* ë°˜íˆ¬ëª… ê²€ì€ìƒ‰ ë°°ê²½ */
            z-index: 1000;
            /* ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .help-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            /* ìµœëŒ€ ë†’ì´ ì„¤ì • */
            overflow-y: auto;
            /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ */
        }

        .help-content h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .help-content h3 {
            color: #555;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .help-content ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 5px;
        }

        .help-content li {
            margin-bottom: 5px;
            font-family: monospace;
            /* ì½”ë“œëŠ” ê³ ì •í­ ê¸€ê¼´ë¡œ */
        }

        .close-info {
            text-align: right;
            font-size: 0.9em;
            color: #999;
            margin-top: 20px;
        }
    </style>
    <div id="latexHelpModal" style="display:none;">
        <div class="latex-help-content">
            <h2>$\sum$ TeX / LaTeX ìˆ˜ì‹ ë¬¸ë²• ë„ì›€ë§</h2>
            <p style="margin-bottom:20px; color:#555;">
                ì„ íƒí•œ ë°•ìŠ¤ì— ì…ë ¥í•˜ëŠ” ë‚´ìš©ì´ MathJaxë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.
            </p>

            <div class="flex-columns">
                <div class="help-column">
                    <h3>ğŸ“Œ ê¸°ë³¸ êµ¬ì¡° ë° í‘œê¸°ë²•</h3>
                    <ul>
                        <li><strong>ì¸ë¼ì¸ ìˆ˜ì‹:</strong> <code>\$ \sum_{i=1}^n i \$</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\sum_{i=1}^n i\)</span></li>
                        <li><strong>ë¸”ë¡ ìˆ˜ì‹:</strong> <code>\$\$ E=mc^2 \$\$</code><br /> (ìƒˆ ì¤„ì— ê°€ìš´ë° ì •ë ¬)</li>
                        <li><strong>ë¶„ìˆ˜:</strong> <code>\frac{ë¶„ì}{ë¶„ëª¨}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\frac{1}{2}\)</span></li>
                        <li><strong>ì œê³±/ì²¨ì:</strong> <code>x^2</code>, <code>y_i</code><br /> ê²°ê³¼: <span
                                class="math-result">\(x_i^2\)</span></li>
                        <li><strong>ì œê³±ê·¼:</strong> <code>\sqrt{ë‚´ìš©}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\sqrt{x^2+y^2}\)</span></li>
                        <li><strong>í–‰ë ¬/ë²¡í„°:</strong> <code>\begin{pmatrix} ... \end{pmatrix}</code></li>
                    </ul>
                </div>

                <div class="help-column">
                    <h3>â— ìì£¼ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜/ê¸°í˜¸</h3>
                    <ul>
                        <li><strong>í•©ê³„:</strong> <code>\sum_{ì•„ë˜}^{ìœ„}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\sum_{i=0}^{\infty} i^2\)</span></li>
                        <li><strong>ì ë¶„:</strong> <code>\int_{ì•„ë˜}^{ìœ„}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\int_0^1 f(x)dx\)</span></li>
                        <li><strong>ê·¹í•œ:</strong> <code>\lim_{n \to \infty}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\lim_{x \to 0} \frac{\sin x}{x}\)</span></li>
                        <li><strong>ì´í•­ ê³„ìˆ˜:</strong> <code>\binom{n}{k}</code><br /> ê²°ê³¼: <span
                                class="math-result">\(\binom{n}{k}\)</span></li>
                        <li><strong>ë…¼ë¦¬ ê¸°í˜¸:</strong> <code>\forall</code>, <code>\exists</code>, <code>\land</code>,
                            <code>\lor</code>
                        </li>
                        <li><strong>í™”ì‚´í‘œ:</strong> <code>\to</code>, <code>\leftarrow</code>,
                            <code>\leftrightarrow</code>, <code>\implies</code>
                        </li>
                    </ul>
                </div>
            </div>

            <p class="close-info">
                ë„ì›€ë§ ë‹«ê¸°: <kbd>F1</kbd> ë˜ëŠ” <kbd>ESC</kbd> í‚¤, í˜¹ì€ ì•„ë¬´ ê³³ì´ë‚˜ í´ë¦­
            </p>
        </div>
    </div>

    <style>
        /* ì¶”ê°€: ìˆ˜ì‹ ê²°ê³¼ ë Œë”ë§ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .math-result {
            display: block;
            margin: 5px 0 0 0;
            padding: 5px;
            background-color: #e3f2fd;
            /* ë°ì€ íŒŒë€ìƒ‰ ë°°ê²½ */
            border-radius: 4px;
            text-align: left;
        }
    </style>




    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>

    <div class="toolbar">
        <div class="btn-group">
            <button id="handToolBtn" title="ì´ë™ ëª¨ë“œ (Space í‚¤)">ğŸ– ì†ë„êµ¬</button>
            <div class="sep" style="height:15px; margin:0 2px;"></div>
            <button id="addContainerBtn">ğŸ“„ íƒ­ ì¶”ê°€</button>
            <button id="deleteContainerBtn" style="color:#d32f2f;">âŒ íƒ­ ì‚­ì œ</button>
            <button id="addBoxBtn">ğŸ“¦ ë°•ìŠ¤</button>
            <button id="addDotBtn" class="btn-dot">ğŸ”´ ì  ì¶”ê°€</button>
        </div>

        <div class="sep"></div>

        <div class="btn-group">
            <button onclick="groupSelectedBoxes()" title="ì„ íƒí•œ ë°•ìŠ¤ ë¬¶ê¸°">ğŸ”— ë¬¶ê¸°</button>
            <button onclick="ungroupSelectedBoxes()" title="ê·¸ë£¹ í•´ì œ">ğŸ”“ í’€ê¸°</button>
        </div>

        <div class="sep"></div>

        <div class="btn-group">
            <button class="btn-align" id="alignLeftBtn" title="ì™¼ìª½ ì •ë ¬">â¬…</button>
            <button class="btn-align" id="alignCenterBtn" title="ê°€ë¡œ ì¤‘ì•™ ì •ë ¬">â•‘</button>
            <button class="btn-align" id="alignRightBtn" title="ì˜¤ë¥¸ìª½ ì •ë ¬">â¡</button>
            <button class="btn-align" id="alignTopBtn" title="ìœ„ìª½ ì •ë ¬">â¬†</button>
            <button class="btn-align" id="alignMiddleBtn" title="ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬">â•</button>
            <button class="btn-align" id="alignBottomBtn" title="ì•„ë˜ìª½ ì •ë ¬">â¬‡</button>
            <button class="btn-align" id="matchWidthBtn" title="ê¸°ì¤€(ë¹¨ê°•) ë°•ìŠ¤ì™€ ë„ˆë¹„ ê°™ê²Œ (ê¸°ì¤€ë°•ìŠ¤ Shift+í´ë¦­)">â†” ë„ˆë¹„ë™ì¼</button>
        </div>

        <div class="sep"></div>
        <div class="btn-group">
            <button class="btn-align" onclick="setTextAlign('left')" title="ê¸€ì ì™¼ìª½ ì •ë ¬">Tâ‡ </button>
            <button class="btn-align" onclick="setTextAlign('center')" title="ê¸€ì ì¤‘ì•™ ì •ë ¬">T|</button>
            <button class="btn-align" onclick="setTextAlign('right')" title="ê¸€ì ì˜¤ë¥¸ìª½ ì •ë ¬">Tâ‡¢</button>
        </div>

        <div class="sep"></div>

        <div class="btn-group">
            <button id="openProjectBtn" class="btn-primary" style="color:#e65100; border:1px solid #ffcc80;">ğŸ“‚
                ì—´ê¸°</button>
            <div class="sep" style="height:15px; margin:0 2px;"></div>

            <select id="saveModeSelect" ...>
                <option value="all">ğŸ“ ëª¨ë“  íƒ­ ì €ì¥ (ìŠ¤ë§ˆíŠ¸ ì €ì¥)</option>
                <option value="saveas">ğŸ’¾ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥</option>
                <option value="selected">â­ ì„ íƒ í•­ëª© ë‚´ë³´ë‚´ê¸°</option>
                <option value="single">ğŸ“¤ í˜„ì¬ íƒ­ ë‚´ë³´ë‚´ê¸°</option>
                <option value="folder">ğŸ“‚ ëª¨ë“  íƒ­ í´ë” ë°±ì—…</option>
            </select>
            <button id="executeSaveBtn" class="btn-primary">âœ… ì‹¤í–‰</button>
        </div>

        <div class="sep"></div>
        <div class="btn-group">
            <button id="importBtn" class="btn-success">â• í•©ì¹˜ê¸°</button>
            <input type="file" id="importFile" accept=".json" style="display:none" />
            <button id="resetDataBtn" style="color:#cc0000;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>

        <div class="sep"></div>


        <div class="btn-group">
            <input type="range" id="containerGray" min="0" max="255" value="255" title="ë°°ê²½ ë°ê¸°" style="width:60px">
            <button id="setBgImgBtn">ğŸ–¼ ë°°ê²½</button>
            <select id="bgModeSelect" title="ë°°ê²½ í‘œì‹œ ë°©ì‹" style="width: 100px;">
                <option value="cover-center">ê½‰ ì±„ìš°ê¸°</option>
                <option value="contain-center">ì „ì²´(ì¤‘ì•™)</option>
                <option value="contain-topleft">ì „ì²´(ì¢Œìƒ)</option>
                <option value="contain-topright">ì „ì²´(ìš°ìƒ)</option>
                <option value="auto-center">ì›ë³¸(ì¤‘ì•™)</option>
                <option value="auto-topleft">ì›ë³¸(ì¢Œìƒ)</option>
                <option value="stretch">í™”ë©´ ë§ì¶¤</option>
            </select>
            <button id="clearBgImgBtn">âŒ ì‚­ì œ</button>
            <input type="file" id="bgImageInput" accept="image/*" style="display:none">
        </div>

        <div class="sep"></div>

        <button id="exportPNG">ğŸ“· ìº¡ì²˜</button>
        <button id="helpBtn" style="background:#ffeb3b; border:1px solid #ccc;">ğŸ’¡ ë„ì›€ë§</button>

        <div class="sep"></div>

        <button id="togglePaletteBtn">ğŸ¨ ìƒ‰ìƒ</button>
        <div id="paletteArea">
            <span> </span>
            <div id="palette"></div>
        </div>

        <span id="currentFileName">íŒŒì¼ëª… ì—†ìŒ</span>
        <span id="autoSaveMsg" class="auto-save-status">âœ” ìë™ ì €ì¥ë¨</span>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="workspace" id="workspace">
        <div id="containerArea" class="container"></div>
    </div>

    <div id="helpModal">

        <div id="helpModalContent">
            <button id="closeHelp">âœ–</button>
            <h2 style="border-bottom:2px solid #0099ff; padding-bottom:10px; color:#0055aa; margin-top:0;">
                ğŸ“˜ ìŠ¤ë§ˆíŠ¸ íŠ¸ë˜ë¸” ë§µ ì—ë””í„° ë§¤ë‰´ì–¼
            </h2>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">

                <div style="flex:1; min-width:300px;">
                    <h3 style="color:#333; border-left:4px solid #0099ff; padding-left:8px;">ğŸ–±ï¸ ê¸°ë³¸ ì¡°ì‘</h3>
                    <ul style="line-height:1.6; color:#555; padding-left:20px;">
                        <li><strong>ë°•ìŠ¤ ì„ íƒ:</strong> í´ë¦­ (í•˜ë‚˜ ì„ íƒ) / <kbd>Ctrl</kbd>+í´ë¦­ (ì—¬ëŸ¬ ê°œ ì¶”ê°€ ì„ íƒ)</li>
                        <li><strong>ë“œë˜ê·¸ ì„ íƒ:</strong> ë¹ˆ ê³µê°„ì—ì„œ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸</li>
                        <li><strong>ì´ë™/í¬ê¸°:</strong> ë°•ìŠ¤ ë“œë˜ê·¸ / ìš°ì¸¡ í•˜ë‹¨ í•¸ë“¤ë¡œ í¬ê¸° ì¡°ì ˆ</li>
                        <li><strong>í…ìŠ¤íŠ¸ í¸ì§‘:</strong> ë°•ìŠ¤ ë”ë¸” í´ë¦­</li>
                        <li><strong>ë³µì œ/ì‚­ì œ:</strong> <kbd>Ctrl</kbd>+<kbd>D</kbd> (ë³µì œ), <kbd>Delete</kbd> (ì‚­ì œ)</li>
                        <li><strong>ì‹¤í–‰ ì·¨ì†Œ:</strong> <kbd>Ctrl</kbd>+<kbd>Z</kbd> (ì·¨ì†Œ), <kbd>Ctrl</kbd>+<kbd>Y</kbd> (ë‹¤ì‹œ
                            ì‹¤í–‰)</li>
                    </ul>

                    <h3 style="color:#333; border-left:4px solid #ff9800; padding-left:8px;">âœ¨ ê·¸ë£¹ & ìƒ‰ìƒ</h3>
                    <ul style="line-height:1.6; color:#555; padding-left:20px;">
                        <li><strong>ê·¸ë£¹ ë¬¶ê¸°:</strong> ì—¬ëŸ¬ ê°œ ì„ íƒ í›„ [ğŸ”— ë¬¶ê¸°] ë²„íŠ¼</li>
                        <li><strong>ê·¸ë£¹ ìƒ‰ìƒ:</strong> ê·¸ë£¹ ì„ íƒ í›„ ìƒë‹¨ [ğŸ¨ ìƒ‰ìƒ]ì—ì„œ ìƒ‰ ì„ íƒ</li>
                        <li><strong>ì—°ê²°ì„ :</strong> ë°•ìŠ¤ ì—°ì† í´ë¦­ (ë˜ëŠ” Shift+í´ë¦­)ìœ¼ë¡œ ì—°ê²°</li>
                        <li><strong>ì„  ê¾¸ë¯¸ê¸°:</strong> ì„  í´ë¦­(í™”ì‚´í‘œ), Shift+í´ë¦­(ìƒ‰ìƒë³€ê²½), Alt+í´ë¦­(ì‚­ì œ)</li>
                    </ul>
                </div>

                <div style="flex:1; min-width:300px;">
                    <h3 style="color:#333; border-left:4px solid #4caf50; padding-left:8px;">ğŸ“ ì •ë ¬ & ë°°ì¹˜</h3>
                    <ul style="line-height:1.6; color:#555; padding-left:20px;">
                        <li><strong>ìë™ ì •ë ¬:</strong> ì—¬ëŸ¬ ê°œ ì„ íƒ í›„ ìƒë‹¨ ì •ë ¬ ì•„ì´ì½˜(â¬…,â•‘,â¡,â¬†...) í´ë¦­</li>
                        <li><strong>ë„ˆë¹„ ë§ì¶¤:</strong> ì—¬ëŸ¬ ê°œ ì„ íƒ í›„ <strong>ê¸°ì¤€(ë¹¨ê°•) ë°•ìŠ¤</strong>ë¥¼ <kbd>Shift</kbd>+í´ë¦­ í•˜ê±°ë‚˜ ìƒë‹¨ [â†”
                            ë„ˆë¹„ë™ì¼] ë²„íŠ¼ í´ë¦­</li>
                        <li><strong>ê¸€ì ì •ë ¬:</strong> [Tâ‡ ] [T|] [Tâ‡¢] ë²„íŠ¼ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì •ë ¬ ë³€ê²½</li>
                    </ul>

                    <h3 style="color:#333; border-left:4px solid #9c27b0; padding-left:8px;">ğŸ“‚ íƒ­(Tab) ê´€ë¦¬ & ì €ì¥</h3>
                    <ul style="line-height:1.6; color:#555; padding-left:20px;">
                        <li><strong>íƒ­ ìˆœì„œ ë³€ê²½:</strong> íƒ­ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë°”ê¾¸ê¸°</li>
                        <li><strong>ë°•ìŠ¤ íƒ­ ì´ë™:</strong> ë°•ìŠ¤ ì„ íƒ í›„, ì˜®ê¸¸ íƒ­ì„ <kbd>Shift</kbd>+<kbd>Ctrl</kbd>+í´ë¦­ (ìœ„ì¹˜ ìœ ì§€)</li>
                        <li><strong>íƒ­ ì´ë¦„ ë³€ê²½:</strong> íƒ­ ë”ë¸” í´ë¦­</li>
                        <li><strong>ì €ì¥:</strong> <kbd>Ctrl</kbd>+<kbd>S</kbd> (í”„ë¡œì íŠ¸ ì €ì¥) / ìë™ ì €ì¥ ì§€ì›</li>
                        <li><strong>ë°°ê²½ ì„¤ì •:</strong> í•˜ë‹¨ ìŠ¬ë¼ì´ë”(ë°ê¸°), [ğŸ–¼ ë°°ê²½] ì´ë¯¸ì§€ ì‚½ì…</li>
                    </ul>
                </div>
            </div>

            <p
                style="background:#f0f8ff; padding:10px; border-radius:5px; border:1px solid #bde0ff; margin-top:20px; font-size:0.95em;">
                <strong>ğŸ’¡ íŒ:</strong> í™”ë©´ì„ ì´ë™í•˜ë ¤ë©´ <kbd>Space</kbd> í‚¤ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ê±°ë‚˜, ìƒë‹¨ì˜ [ğŸ– ì†ë„êµ¬] ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.
            </p>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>

        document.addEventListener('keydown', e => {
            // F1 í‚¤ ê°ì§€
            if (e.key === 'F1') {
                e.preventDefault();

                const modal = document.getElementById('latexHelpModal');
                // í˜„ì¬ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í‘œì‹œ, í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìˆ¨ê¹€
                if (modal.style.display === 'none') {
                    modal.style.display = 'flex';

                    // [â˜… ìˆ˜ì •] ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ MathJax ë Œë”ë§ì„ ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ìˆ˜ì‹ ë³´ì´ê²Œ í•¨
                    // MathJaxê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ëª¨ë‹¬ ìš”ì†Œë§Œ ë Œë”ë§í•˜ë„ë¡ ì§€ì •
                    if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                        MathJax.typeset([modal]);
                    }

                } else {
                    modal.style.display = 'none';
                }
            }

            // ESC í‚¤ ê°ì§€ (ë„ì›€ë§ ì°½ ë‹«ê¸°ìš©)
            if (e.key === 'Escape') {
                const modal = document.getElementById('latexHelpModal');
                if (modal && modal.style.display !== 'none') {
                    modal.style.display = 'none';
                }
            }
        });


        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
        document.getElementById('latexHelpModal').addEventListener('click', function (e) {
            // í´ë¦­ëœ ìš”ì†Œê°€ ë„ì›€ë§ ë‚´ìš©(.help-content) ìì²´ê°€ ì•„ë‹ ê²½ìš°ì—ë§Œ ë‹«ê¸°
            if (e.target.id === 'latexHelpModal') {
                e.target.style.display = 'none';
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            let containers = [], boxes = [], activeContainerId = null;

            // [ê¸°ì¡´ ì½”ë“œ]
            let selectedBoxIds = [], linkLines = [], linkingBoxId = null;
            let dragSelectRect = null, dragStart = null;

            // [â˜… ì¶”ê°€í•  ì½”ë“œ] ê·¸ë£¹ ìƒ‰ìƒì„ ì €ì¥í•  ê°ì²´
            let groupColors = {};

            const STORAGE_KEY = 'myMapEditorData_smartAlign';

            let isSpacePressed = false;
            let isHandMode = false;
            let isPanning = false;
            let panStartX = 0, panStartY = 0;
            let scrollStartX = 0, scrollStartY = 0;

            let currentFileHandle = null;

            const colors = [
                '#ff0000', '#ffffff', '#f1f3f5', '#e9ecef', '#dee2e6',
                '#fff9db', '#fff3bf', '#ffec99', '#ffe066',
                '#ffe8cc', '#ffd8a8', '#ffc078', '#ffa94d',
                '#ffc9c9', '#ff8787', '#fa5252', '#fcc2d7',
                '#eebefa', '#cc5de8', '#d0bfff', '#b197fc',
                '#d0ebff', '#74c0fc', '#4dabf7', '#339af0',
                '#e3fafc', '#99e9f2', '#66d9e8', '#22b8cf',
                '#d3f9d8', '#b2f2bb', '#69db7c', '#40c057',
                '#f4fce3', '#d8f5a2', '#a9e34b', '#82c91e'
            ];

            const palette = document.getElementById('palette');
            const paletteArea = document.getElementById('paletteArea');
            const togglePaletteBtn = document.getElementById('togglePaletteBtn');
            const handToolBtn = document.getElementById('handToolBtn');

            const workspace = document.getElementById('workspace');
            const containerArea = document.getElementById('containerArea');
            const graySlider = document.getElementById('containerGray');
            const bgModeSelect = document.getElementById('bgModeSelect');
            const saveModeSelect = document.getElementById('saveModeSelect');
            const autoSaveMsg = document.getElementById('autoSaveMsg');
            const currentFileNameSpan = document.getElementById('currentFileName');

            let undoStack = [], redoStack = [], MAX_HISTORY = 50;
            const selectionHistoryStack = [];

            togglePaletteBtn.onclick = () => {
                if (paletteArea.classList.contains('hidden')) {
                    paletteArea.classList.remove('hidden');
                    togglePaletteBtn.style.background = '';
                } else {
                    paletteArea.classList.add('hidden');
                    togglePaletteBtn.style.background = '#ddd';
                }
            };

            handToolBtn.onclick = () => {
                isHandMode = !isHandMode;
                if (isHandMode) {
                    handToolBtn.style.background = '#ffe082';
                    handToolBtn.style.border = '1px solid #ffca28';
                    workspace.classList.add('grab');
                } else {
                    handToolBtn.style.background = '';
                    handToolBtn.style.border = '';
                    workspace.classList.remove('grab');
                }
            };

            function saveToLocalStorage() {
                const data = { containers, boxes, linkLines, activeContainerId, groupColors };
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    autoSaveMsg.textContent = "âœ” ìë™ ì €ì¥ë¨";
                    autoSaveMsg.style.display = 'block';
                    setTimeout(() => { autoSaveMsg.style.display = 'none'; }, 1000);
                } catch (e) {
                    console.warn("Local Storage Quota Exceeded");
                }
            }


            //====================
            function loadFromLocalStorage() {
                const dataStr = localStorage.getItem(STORAGE_KEY);
                if (dataStr) {
                    try {
                        const data = JSON.parse(dataStr); // data ë³€ìˆ˜ ìƒì„±

                        containers = data.containers || [];
                        boxes = data.boxes || [];
                        linkLines = data.linkLines || [];
                        activeContainerId = data.activeContainerId || (containers[0] ? containers[0].id : null);

                        // [â˜… ìœ„ì¹˜ í™•ì¸] ì—¬ê¸°ë„ dataê°€ ë§Œë“¤ì–´ì§„ ë’¤ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                        groupColors = data.groupColors || {};

                    } catch (e) { console.error(e); }
                }
            }



            function pushHistory() {
                try {
                    undoStack.push(JSON.stringify({ containers, boxes, linkLines, activeContainerId, groupColors }));
                    if (undoStack.length > MAX_HISTORY) undoStack.shift();
                    redoStack = [];
                    saveToLocalStorage();
                } catch (e) { console.warn("History push failed"); }
            }

            function undo() { if (!undoStack.length) return; redoStack.push(JSON.stringify({ containers, boxes, linkLines, activeContainerId })); const last = JSON.parse(undoStack.pop()); containers = last.containers; boxes = last.boxes; linkLines = last.linkLines; activeContainerId = last.activeContainerId; selectedBoxIds = []; renderTabs(); renderBoxes(); saveToLocalStorage(); }
            function redo() { if (!redoStack.length) return; undoStack.push(JSON.stringify({ containers, boxes, linkLines, activeContainerId })); const next = JSON.parse(redoStack.pop()); containers = next.containers; boxes = next.boxes; linkLines = next.linkLines; activeContainerId = next.activeContainerId; selectedBoxIds = []; renderTabs(); renderBoxes(); saveToLocalStorage(); }

            function createContainer(name) {
                const id = 'c' + Date.now() + Math.random().toString(16).slice(2);
                containers.push({ id, name, bg: 255, bgImage: null, bgMode: 'cover-center' });
                setActiveContainer(id); renderTabs(); pushHistory();
            }

            function setActiveContainer(id) {
                if (!id) return;
                activeContainerId = id;
                renderTabs();
                const container = containers.find(c => c.id === activeContainerId);
                if (container) {
                    graySlider.value = container.bg;
                    bgModeSelect.value = container.bgMode || 'cover-center';
                }
                renderBoxes();
            }
            // [ìˆ˜ì •] ìŠ¬ë¼ì´ë” ë“œë˜ê·¸ ì¤‘ì—ëŠ” í™”ë©´ë§Œ ê°±ì‹  (íˆìŠ¤í† ë¦¬ ì €ì¥ X)
            graySlider.oninput = () => {
                if (!activeContainerId) return;
                const c = containers.find(c => c.id === activeContainerId);
                if (!c) return;
                c.bg = parseInt(graySlider.value);
                renderBoxes();
            };

            // [ì¶”ê°€] ìŠ¬ë¼ì´ë” ì¡°ì‘ì´ ëë‚¬ì„ ë•Œ(ë§ˆìš°ìŠ¤ ë—ì„ ë•Œ) íˆìŠ¤í† ë¦¬ ì €ì¥
            graySlider.onchange = () => {
                pushHistory();
            };
            bgModeSelect.onchange = (e) => {
                if (!activeContainerId) return;
                const c = containers.find(c => c.id === activeContainerId);
                if (c) {
                    c.bgMode = e.target.value;
                    renderBoxes();
                    pushHistory();
                }
            };



            //=======================================================================

            // [â˜… ìµœì¢… í†µí•©: íƒ­ ë“œë˜ê·¸ ìˆœì„œ ë³€ê²½ + Shift+Ctrl í´ë¦­ìœ¼ë¡œ 'ëª¨ì–‘ ìœ ì§€' ì´ë™]
            function renderTabs() {
                const tabsEl = document.querySelector('.tabs');
                tabsEl.innerHTML = '';

                containers.forEach((c, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'tab' + (c.id === activeContainerId ? ' active' : '');
                    tab.textContent = c.name;

                    // ===============================================
                    // [ê¸°ëŠ¥ 1] íƒ­ ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ìˆœì„œ ë³€ê²½)
                    // ===============================================
                    tab.draggable = true; // ë“œë˜ê·¸ ê°€ëŠ¥ ì„¤ì •

                    // ë“œë˜ê·¸ ì‹œì‘: í˜„ì¬ íƒ­ì˜ ìœ„ì¹˜(index) ê¸°ì–µ
                    tab.ondragstart = (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('fromIndex', index);
                        tab.style.opacity = '0.5'; // íë¦¬ê²Œ íš¨ê³¼
                    };

                    // ë“œë˜ê·¸ ì¢…ë£Œ: íš¨ê³¼ ë³µêµ¬
                    tab.ondragend = () => { tab.style.opacity = '1'; };

                    // ë“œë˜ê·¸ ì¤‘: ë†“ê¸° í—ˆìš©
                    tab.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };

                    // ë“œë¡­(ë†“ê¸°): ìˆœì„œ êµì²´ ì‹¤í–‰
                    tab.ondrop = (e) => {
                        e.preventDefault();
                        const fromIndex = parseInt(e.dataTransfer.getData('fromIndex'));
                        const toIndex = index;

                        // ì œìë¦¬ ë“œë¡­ì´ë©´ ë¬´ì‹œ
                        if (fromIndex === toIndex) return;

                        // ë°°ì—´ì—ì„œ ë¹¼ì„œ(splice) -> ìƒˆ ìœ„ì¹˜ì— ë„£ê¸°(splice)
                        const movedItem = containers.splice(fromIndex, 1)[0];
                        containers.splice(toIndex, 0, movedItem);

                        renderTabs();
                        pushHistory();
                    };

                    // [ê¸°ëŠ¥ 2] íƒ­ í´ë¦­ ì´ë²¤íŠ¸ (íƒ­ ì „í™˜ OR ë°•ìŠ¤ ì´ë™)
                    tab.onclick = (e) => {
                        // ì¡°ê±´: Shift + Ctrl í‚¤ë¥¼ ëˆ„ë¥¸ ìƒíƒœì¸ê°€?
                        if (e.shiftKey && (e.ctrlKey || e.metaKey)) {
                            // ê²€ì¦ 1: ì„ íƒëœ ë°•ìŠ¤ê°€ ìˆëŠ”ê°€?
                            if (selectedBoxIds.length === 0) {
                                alert('ì´ë™í•  ë°•ìŠ¤ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            // ê²€ì¦ 2: í˜„ì¬ íƒ­ìœ¼ë¡œ ì´ë™í•˜ë ¤ê³  í•˜ëŠ”ê°€?
                            if (c.id === activeContainerId) {
                                alert('í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì…ë‹ˆë‹¤.');
                                return;
                            }

                            // -----------------------------------------------------------
                            // [â˜… ì¶”ê°€í•  ì½”ë“œ ì‹œì‘] ì„ íƒëœ ë°•ìŠ¤ì— ì—°ê²°ëœ 'ê·¸ë£¹ ì „ì²´'ë¥¼ ìë™ìœ¼ë¡œ í¬í•¨í•˜ê¸°
                            // -----------------------------------------------------------
                            let boxesToMove = boxes.filter(b => selectedBoxIds.includes(b.id));

                            // 1. ì„ íƒëœ ë°•ìŠ¤ë“¤ì´ ì†í•œ ëª¨ë“  ê·¸ë£¹ ID ìˆ˜ì§‘
                            const relatedGroupIds = new Set();
                            boxesToMove.forEach(b => {
                                if (b.groupIds && b.groupIds.length > 0) {
                                    b.groupIds.forEach(gid => relatedGroupIds.add(gid));
                                }
                            });

                            // 2. í•´ë‹¹ ê·¸ë£¹ IDë¥¼ ê°€ì§„ í˜„ì¬ íƒ­ì˜ ëª¨ë“  ë°•ìŠ¤ë¥¼ ì´ë™ ëª©ë¡ì— ì¶”ê°€
                            if (relatedGroupIds.size > 0) {
                                const groupMembers = boxes.filter(b =>
                                    b.containerId === activeContainerId &&
                                    b.groupIds &&
                                    b.groupIds.some(gid => relatedGroupIds.has(gid))
                                );

                                groupMembers.forEach(member => {
                                    // ì´ë¯¸ ì´ë™ ëª©ë¡ì— ì—†ìœ¼ë©´ ì¶”ê°€
                                    if (!boxesToMove.includes(member)) {
                                        boxesToMove.push(member);
                                    }
                                });
                            }
                            // [â˜… ì¶”ê°€í•  ì½”ë“œ ë] -----------------------------------------


                            // --- [ê¸°ì¡´ ë°•ìŠ¤ ì´ë™ ë¡œì§: boxesToMove ë³€ìˆ˜ ì‚¬ìš©] ---
                            // (ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” selectedBoxIdsë¡œ í•„í„°ë§í–ˆìœ¼ë‚˜, ì´ì œ boxesToMoveë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤)

                            // 1. ê¸°ì¤€ì  ì°¾ê¸° (ê°€ì¥ ì™¼ìª½/ìœ„ìª½)
                            let minX = Infinity; let minY = Infinity;

                            // [ìˆ˜ì •] ìœ„ì—ì„œ ë§Œë“  boxesToMove ë°°ì—´ì„ ì‚¬ìš©í•˜ì„¸ìš”
                            boxesToMove.forEach(b => {
                                if (b.x < minX) minX = b.x;
                                if (b.y < minY) minY = b.y;
                            });

                            // 2. ì´ë™ ì‹¤í–‰
                            boxesToMove.forEach(b => {
                                b.containerId = c.id; // ì†Œì† íƒ­ ë³€ê²½

                                // ìƒˆ íƒ­ì˜ (50, 50) ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª¨ì–‘ ìœ ì§€í•˜ë©° ë°°ì¹˜
                                b.x = 50 + (b.x - minX);
                                b.y = 50 + (b.y - minY);
                            });

                            // 3. ì—°ê²°ì„  ì²˜ë¦¬ (ì–‘ìª½ ëì´ ëª¨ë‘ ì´ë™í•œ ê²½ìš°ì—ë§Œ ìœ ì§€ë¨)
                            // ì´ë™í•œ ë°•ìŠ¤ë“¤ì˜ ID ëª©ë¡
                            const movedIds = boxesToMove.map(b => b.id);

                            // ì—°ê²°ì„ ë„ íƒ­ ì •ë³´ë¥¼ ë”°ë¼ê°€ê²Œ í•˜ê±°ë‚˜, ë¡œì§ì— ë”°ë¼ ì²˜ë¦¬ (ë³´í†µ ë°•ìŠ¤ë§Œ ì˜®ê¸°ë©´ ë¨)
                            // ë§Œì•½ ì—°ê²°ì„  ë°ì´í„°ì— containerIdê°€ ì—†ë‹¤ë©´ ë°•ìŠ¤ë§Œ ì˜®ê²¨ë„ ë Œë”ë§ ì‹œ ìë™ìœ¼ë¡œ ë”°ë¼ì˜µë‹ˆë‹¤.

                            // 4. ë§ˆë¬´ë¦¬
                            selectedBoxIds = []; // ì„ íƒ í•´ì œ
                            renderBoxes();       // í˜„ì¬ í™”ë©´(ë°•ìŠ¤ê°€ ì‚¬ë¼ì§) ê°±ì‹ 
                            pushHistory();       // ê¸°ë¡ ì €ì¥

                            // (ì„ íƒ ì‚¬í•­) ì´ë™ í›„ ì•Œë¦¼
                            // alert(`${boxesToMove.length}ê°œì˜ ë°•ìŠ¤(ê·¸ë£¹ í¬í•¨)ê°€ '${c.name}' íƒ­ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            return;
                        }

                        // [ê¸°ì¡´ ê¸°ëŠ¥: ë‹¨ìˆœ íƒ­ ì „í™˜]
                        activeContainerId = c.id;
                        renderTabs();
                        renderBoxes();
                    };






                    // [ê¸°íƒ€] ë”ë¸”í´ë¦­ ì‹œ ì´ë¦„ ë³€ê²½
                    tab.ondblclick = (e) => {
                        e.stopPropagation();
                        const newName = prompt('íƒ­ ì´ë¦„ ë³€ê²½:', c.name);
                        if (newName) {
                            c.name = newName;
                            renderTabs();
                            pushHistory();
                        }
                    };

                    tabsEl.appendChild(tab);
                });

                // [+] ë²„íŠ¼ ì¶”ê°€
                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.style.padding = '5px 10px';
                addBtn.style.cursor = 'pointer';
                addBtn.style.border = 'none';
                addBtn.style.background = 'transparent';
                addBtn.style.fontSize = '1.2rem';
                addBtn.onclick = () => {
                    const name = prompt('ìƒˆ íƒ­ ì´ë¦„:');
                    if (name) {
                        const newId = 'c' + Date.now();
                        containers.push({ id: newId, name: name });
                        activeContainerId = newId;
                        renderTabs();
                        renderBoxes();
                        pushHistory();
                    }
                };
                tabsEl.appendChild(addBtn);
            }
            //========================================================================
            function createBox(type = 'normal') {
                if (!activeContainerId) return alert('ë¨¼ì € íƒ­(ì»¨í…Œì´ë„ˆ)ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                const id = 'b' + Date.now() + Math.random().toString(16).slice(2);
                let box = { id, containerId: activeContainerId, x: 50, y: 50, type: type };
                if (type === 'dot') { box.text = ''; box.color = '#ff0000'; box.width = 24; box.height = 24; }
                else { box.text = 'ìƒˆ ë°•ìŠ¤'; box.color = '#fff9db'; box.width = 100; box.height = 40; }
                boxes.push(box); renderBoxes(); pushHistory();
            }

            //=ìˆ˜í•™ ê¸°í˜¸ ì‚¬ìš©ì„ ìœ„í•œ ë…¸ë ¥
            // [ìƒˆë¡œ ì¶”ê°€í•  í•¨ìˆ˜]: ë°•ìŠ¤ì˜ ë‚´ìš©ì„ HTMLë¡œ í• ë‹¹í•˜ê³  MathJaxê°€ ì¸ì‹í•˜ë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤.
            function setBoxContent(boxElement, text) {
                boxElement.innerHTML = text || '';
            }
            //======================
            //================
            // [â˜… ìˆ˜ì •í•  ì½”ë“œ] renderGroups í•¨ìˆ˜ ì „ì²´ êµì²´
            function renderGroups() {
                document.querySelectorAll('.group-rect').forEach(el => el.remove());
                const activeBoxes = boxes.filter(b => b.containerId === activeContainerId);

                const groupBounds = {};

                activeBoxes.forEach(b => {
                    if (b.groupId && !b.groupIds) { b.groupIds = [b.groupId]; delete b.groupId; }
                    if (!b.groupIds) b.groupIds = [];

                    b.groupIds.forEach(gid => {
                        if (!groupBounds[gid]) groupBounds[gid] = { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity, count: 0 };
                        const g = groupBounds[gid];
                        g.minX = Math.min(g.minX, b.x);
                        g.minY = Math.min(g.minY, b.y);
                        g.maxX = Math.max(g.maxX, b.x + b.width);
                        g.maxY = Math.max(g.maxY, b.y + b.height);
                        g.count++;
                    });
                });

                Object.keys(groupBounds).forEach(gid => {
                    const g = groupBounds[gid];
                    if (g.count === 0) return;
                    const padding = 15;
                    const rect = document.createElement('div');
                    rect.className = 'group-rect';
                    rect.style.left = (g.minX - padding) + 'px';
                    rect.style.top = (g.minY - padding) + 'px';
                    rect.style.width = (g.maxX - g.minX + padding * 2) + 'px';
                    rect.style.height = (g.maxY - g.minY + padding * 2) + 'px';

                    // [ìƒ‰ìƒ ì ìš© ë¡œì§]
                    // ì €ì¥ëœ ìƒ‰ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ íšŒìƒ‰
                    const baseColor = groupColors[gid] || '#999999';

                    // í…Œë‘ë¦¬ëŠ” ì¡°ê¸ˆ ì§„í•˜ê²Œ (íˆ¬ëª…ë„ 0.5)
                    rect.style.border = `2px dashed ${hexToRgba(baseColor, 0.6)}`;
                    // ë°°ê²½ì€ ì•„ì£¼ ì—°í•˜ê²Œ (íˆ¬ëª…ë„ 0.1)
                    rect.style.background = hexToRgba(baseColor, 0.1);

                    containerArea.appendChild(rect);
                });
            }
            //==============
            function renderBoxes() {
                renderGroups();
                document.querySelectorAll('.box').forEach(el => el.remove());

                if (!activeContainerId) return;
                const activeBoxes = boxes.filter(b => b.containerId === activeContainerId);
                const activeContainer = containers.find(c => c.id === activeContainerId);
                if (!activeContainer) return;

                containerArea.style.backgroundColor = `rgb(${activeContainer.bg},${activeContainer.bg},${activeContainer.bg})`;

                if (activeContainer.bgImage) {
                    containerArea.style.backgroundImage = `url(${activeContainer.bgImage})`;
                    const mode = activeContainer.bgMode || 'cover-center';
                    containerArea.style.backgroundSize = ''; containerArea.style.backgroundPosition = '';
                    switch (mode) {
                        case 'contain-center': containerArea.style.backgroundSize = 'contain'; containerArea.style.backgroundPosition = 'center'; break;
                        case 'contain-topleft': containerArea.style.backgroundSize = 'contain'; containerArea.style.backgroundPosition = 'top left'; break;
                        case 'contain-topright': containerArea.style.backgroundSize = 'contain'; containerArea.style.backgroundPosition = 'top right'; break;
                        case 'auto-center': containerArea.style.backgroundSize = 'auto'; containerArea.style.backgroundPosition = 'center'; break;
                        case 'auto-topleft': containerArea.style.backgroundSize = 'auto'; containerArea.style.backgroundPosition = 'top left'; break;
                        case 'stretch': containerArea.style.backgroundSize = '100% 100%'; containerArea.style.backgroundPosition = 'center'; break;
                        case 'cover-center': default: containerArea.style.backgroundSize = 'cover'; containerArea.style.backgroundPosition = 'center'; break;
                    }
                } else {
                    containerArea.style.backgroundImage = 'none';
                }

                activeBoxes.forEach(b => {
                    if (!b) return;
                    const div = document.createElement('div');
                    div.dataset.id = b.id;
                    div.className = b.type === 'dot' ? 'box dot' : 'box normal';
                    div.textContent = b.text;
                    div.style.left = b.x + 'px'; div.style.top = b.y + 'px';
                    div.style.width = b.width + 'px'; div.style.height = b.height + 'px';




                    // [ê¸°ì¡´ ì½”ë“œ]
                    div.style.background = b.color;

                    // [ì•„ë˜ ì½”ë“œë¥¼ ë°”ë¡œ ë°‘ì— ì¶”ê°€í•˜ì„¸ìš”]
                    // -----------------------------------------------------------
                    const align = b.textAlign || 'center'; // ê°’ì´ ì—†ìœ¼ë©´ ì¤‘ì•™ ì •ë ¬ì´ ê¸°ë³¸
                    div.style.textAlign = align;

                    // flex ë ˆì´ì•„ì›ƒì´ë¯€ë¡œ justify-contentë„ ê°™ì´ ë§ì¶°ì¤˜ì•¼ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.
                    if (align === 'left') div.style.justifyContent = 'flex-start';
                    else if (align === 'right') div.style.justifyContent = 'flex-end';
                    else div.style.justifyContent = 'center';
                    // -----------------------------------------------------------

                    // [ìˆ˜ì •ë¨] ì„ íƒ ìˆœì„œì— ë”°ë¼ ìŠ¤íƒ€ì¼ êµ¬ë¶„ (0ë²ˆ:ê¸°ì¤€/Red, ë‚˜ë¨¸ì§€:Blue)
                    const selectionIndex = selectedBoxIds.indexOf(b.id);
                    if (selectionIndex === 0) {
                        div.classList.add('selected', 'primary'); // ê¸°ì¤€: ë¹¨ê°•
                    } else if (selectionIndex > 0) {
                        div.classList.add('selected', 'secondary'); // ì¶”ê°€: íŒŒë‘
                    }

                    div.onmousedown = e => {
                        if (isHandMode || isSpacePressed || e.button === 1) return;

                        if (e.button !== 0) return; e.stopPropagation();
                        // [â˜… ì¶”ê°€í•  ì½”ë“œ ì‹œì‘] Alt + í´ë¦­ ì‹œ ê·¸ë£¹ ì „ì²´ ì„ íƒ ê¸°ëŠ¥
                        if (e.altKey) {
                            // í˜„ì¬ ë°•ìŠ¤ê°€ ì†í•œ ê·¸ë£¹ ID í™•ì¸
                            const myGroupIds = b.groupIds || [];

                            // ê·¸ë£¹ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰
                            if (myGroupIds.length > 0) {
                                // í˜„ì¬ í™”ë©´(activeBoxes)ì— ìˆëŠ” ë°•ìŠ¤ ì¤‘, ê°™ì€ ê·¸ë£¹ IDë¥¼ í•˜ë‚˜ë¼ë„ ê°€ì§„ ë°•ìŠ¤ ì°¾ê¸°
                                const groupMembers = activeBoxes.filter(target =>
                                    (target.groupIds || []).some(gid => myGroupIds.includes(gid))
                                );

                                // ì°¾ì€ ê·¸ë£¹ ë©¤ë²„ë“¤ì„ ì„ íƒ ëª©ë¡(selectedBoxIds)ì— ì¶”ê°€
                                let changed = false;
                                groupMembers.forEach(member => {
                                    if (!selectedBoxIds.includes(member.id)) {
                                        selectedBoxIds.push(member.id);
                                        changed = true;
                                    }
                                });

                                if (changed) {
                                    renderBoxes(); // í™”ë©´ ê°±ì‹ í•˜ì—¬ ì„ íƒ í‘œì‹œ
                                    // ì•Œë¦¼ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
                                    // alert('ê·¸ë£¹ ì „ì²´ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ íƒ­ì„ Shift+Ctrl+í´ë¦­í•˜ì—¬ ì´ë™í•˜ì„¸ìš”.');
                                }
                                return; // ì´í›„ ë¡œì§(ë‹¨ì¼ ì„ íƒ ë“±) ì‹¤í–‰ ë°©ì§€
                            }
                        }
                        // [â˜… ì¶”ê°€í•  ì½”ë“œ ë]

                        if (e.shiftKey) {
                            if (selectedBoxIds.length === 0) return;

                            // [í•µì‹¬ ê¸°ëŠ¥] ê¸°ì¤€ ë°•ìŠ¤ë¥¼ ë‹¤ì‹œ Shift í´ë¦­í•˜ë©´ ë„ˆë¹„ ë§ì¶¤ ì‹¤í–‰
                            if (selectedBoxIds.length > 1 && selectedBoxIds[0] === b.id) {
                                matchWidthToFirst();
                                return;
                            }

                            // ê¸°ì¡´ ì—°ê²° ê¸°ëŠ¥
                            if (linkingBoxId && linkingBoxId !== b.id) {
                                const exists = linkLines.find(l => l.from === linkingBoxId && l.to === b.id);
                                if (!exists) linkLines.push({ from: linkingBoxId, to: b.id });
                                linkingBoxId = null; renderBoxes(); pushHistory();
                            } else { linkingBoxId = b.id; }
                            return;
                        }
                        if (e.ctrlKey) {
                            if (!selectedBoxIds.includes(b.id)) {
                                selectedBoxIds.push(b.id); // ìˆœì„œëŒ€ë¡œ ì¶”ê°€ë¨
                            }
                            renderBoxes(); // ìŠ¤íƒ€ì¼ ê°±ì‹ 
                            dragSelectedBoxes(e); return;
                        }

                        // ì¼ë°˜ í´ë¦­ (ë‹¤ì¤‘ ê·¸ë£¹ ì§€ì› ìˆ˜ì •)
                        const isAlreadySelected = selectedBoxIds.includes(b.id);
                        if (!isAlreadySelected) {
                            // êµ¬ë²„ì „ í˜¸í™˜
                            if (b.groupId && !b.groupIds) { b.groupIds = [b.groupId]; delete b.groupId; }

                            if (b.groupIds && b.groupIds.length > 0) {
                                // ê°€ì¥ ìµœê·¼(ê°€ì¥ ë°”ê¹¥ìª½) ê·¸ë£¹ ID ê°€ì ¸ì˜¤ê¸°
                                const currentTopGroupId = b.groupIds[b.groupIds.length - 1];
                                // í•´ë‹¹ ê·¸ë£¹ IDë¥¼ ê°€ì§„ ëª¨ë“  ë°•ìŠ¤ ì„ íƒ
                                const groupPeers = boxes.filter(x =>
                                    x.containerId === activeContainerId &&
                                    (x.groupId === currentTopGroupId || (x.groupIds && x.groupIds.includes(currentTopGroupId)))
                                );
                                selectedBoxIds = groupPeers.map(p => p.id);
                            } else {
                                selectedBoxIds = [b.id];
                            }
                            renderBoxes();
                        }


                        linkingBoxId = b.id;
                        dragSelectedBoxes(e);
                    };
                    div.onclick = e => { e.stopPropagation(); };
                    div.ondblclick = e => { e.stopPropagation(); if (b.type === 'dot' || e.shiftKey) return; editBoxText(div, b); };
                    if (b.type !== 'dot') { const resizeHandle = document.createElement('div'); resizeHandle.className = 'resizeHandle'; div.appendChild(resizeHandle); resizeHandle.onmousedown = e => { resizeBox(div, b, e); }; }
                    containerArea.appendChild(div);
                });

                // [ì¶”ê°€í•  ì½”ë“œ] (updateLines() ì§ì „)
                if (window.MathJax) {
                    MathJax.typesetPromise([containerArea]);
                }
                updateLines();
            }

            // [ì¶”ê°€ëœ ê¸°ëŠ¥] ì²«ë²ˆì§¸ ë°•ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ë„ˆë¹„ ë§ì¶¤
            function matchWidthToFirst() {
                if (selectedBoxIds.length < 2) return alert('2ê°œ ì´ìƒì˜ ë°•ìŠ¤ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.\n(ë¹¨ê°„ ë°•ìŠ¤ = ê¸°ì¤€, íŒŒë€ ë°•ìŠ¤ = ë³€ê²½ ëŒ€ìƒ)');

                const primaryId = selectedBoxIds[0];
                const primaryBox = boxes.find(b => b.id === primaryId);
                if (!primaryBox) return;

                const targetWidth = primaryBox.width;
                let changeCount = 0;

                selectedBoxIds.slice(1).forEach(id => {
                    const targetBox = boxes.find(b => b.id === id);
                    if (targetBox && targetBox.type !== 'dot') {
                        targetBox.width = targetWidth;
                        changeCount++;
                    }
                });

                if (changeCount > 0) {
                    renderBoxes();
                    pushHistory();
                    // í”¼ë“œë°± íš¨ê³¼ (ì ê¹ ë°˜ì§ì„)
                    const primaryDiv = containerArea.querySelector(`.box[data-id="${primaryId}"]`);
                    if (primaryDiv) {
                        const originalOutline = primaryDiv.style.outline;
                        primaryDiv.style.outline = "5px solid #ff0000";
                        setTimeout(() => { renderBoxes(); }, 200);
                    }
                }
            }

            document.getElementById('matchWidthBtn').onclick = matchWidthToFirst;

            function updateLines() {
                document.querySelectorAll('.linkLine').forEach(l => l.remove());
                const activeBoxes = boxes.filter(b => b.containerId === activeContainerId);
                linkLines.forEach(l => {
                    const from = activeBoxes.find(x => x.id === l.from); const to = activeBoxes.find(x => x.id === l.to); if (!from || !to) return;
                    const x1 = from.x + from.width / 2, y1 = from.y + from.height / 2; const x2 = to.x + to.width / 2, y2 = to.y + to.height / 2;
                    let length = Math.hypot(x2 - x1, y2 - y1); const angleRad = Math.atan2(y2 - y1, x2 - x1); const angleDeg = angleRad * 180 / Math.PI;
                    const toW = to.width / 2; const toH = to.height / 2; const tanA = Math.abs(Math.tan(angleRad)); const boxRatio = toH / toW;
                    let distToEdge = 0; if (tanA < boxRatio) distToEdge = Math.abs(toW / Math.cos(angleRad)); else distToEdge = Math.abs(toH / Math.sin(angleRad));
                    length = length - distToEdge - 3; if (length < 0) length = 0;
                    const line = document.createElement('div'); line.className = 'linkLine';
                    if (l.hasArrow) line.classList.add('arrow'); if (l.color) line.classList.add(l.color);
                    line.style.left = x1 + 'px'; line.style.top = y1 + 'px'; line.style.width = length + 'px'; line.style.transform = `rotate(${angleDeg}deg)`;
                    line.onclick = ev => {
                        ev.stopPropagation();
                        if (ev.altKey) { linkLines = linkLines.filter(l2 => l2 !== l); }
                        else if (ev.shiftKey) { if (!l.color) l.color = 'red'; else if (l.color === 'red') l.color = 'blue'; else l.color = null; }
                        else { l.hasArrow = !l.hasArrow; }
                        renderBoxes(); pushHistory();
                    };
                    containerArea.appendChild(line);
                });
            }

            function editBoxText(div, boxData) {
                if (div.querySelector('textarea')) return;
                const textarea = document.createElement('textarea'); textarea.value = boxData.text;


                //  ì‚­ì œ í•  ìˆ˜ë„ ìˆìŒ

                textarea.style.cssText = `width:100%; height:100%; border:none; background:transparent;text-align:center; outline:none;  resize:none; overflow:hidden; font-family:"ë§‘ì€ ê³ ë”•",sans-serif; font-size:14px; line-height:1.4; padding:0; margin:0;`;
                textarea.style.textAlign = boxData.textAlign || 'center'; // ì´ ì¤„ ì¶”ê°€!



                div.innerHTML = ''; div.appendChild(textarea); textarea.focus();
                const autoResize = () => { textarea.style.height = '1px'; let newHeight = textarea.scrollHeight + 10; if (newHeight < 34) newHeight = 30; div.style.height = newHeight + 'px'; textarea.style.height = '100%'; };
                textarea.addEventListener('input', autoResize); autoResize();
                const saveInput = () => { boxData.text = textarea.value; textarea.style.height = '1px'; let finalHeight = textarea.scrollHeight + 10; if (finalHeight < 34) finalHeight = 30; boxData.height = finalHeight; renderBoxes(); pushHistory(); };
                textarea.onkeydown = ev => { ev.stopPropagation(); if (ev.key === 'Escape') { renderBoxes(); } };
                textarea.onblur = () => saveInput();
            }

            //====================

            function cloneSelectedBoxes() {
                if (selectedBoxIds.length === 0) return;
                const idMap = {};
                const newBoxes = [];

                selectedBoxIds.forEach(bid => {
                    const boxData = boxes.find(x => x.id == bid);
                    if (!boxData) return;

                    const newId = 'b' + Date.now() + Math.random().toString(16).slice(2);
                    idMap[boxData.id] = newId;

                    // [ìˆ˜ì • í•µì‹¬] groupIdì™€ groupIdsë¥¼ ëª¨ë‘ ë¶„ë¦¬í•´ë‚´ê³ , ë³µì œë³¸ì—ëŠ” ë¹ˆ ë°°ì—´ì„ í• ë‹¹
                    const { groupId, groupIds, ...rest } = boxData;

                    const clone = {
                        ...rest,
                        id: newId,
                        x: boxData.x + 20,
                        y: boxData.y + 20,
                        groupIds: [] // ë³µì œëœ ë°•ìŠ¤ëŠ” ê·¸ë£¹ì´ ì—†ëŠ” ìƒíƒœë¡œ ì‹œì‘
                    };

                    newBoxes.push(clone);
                    boxes.push(clone);
                });

                const newLinkLines = [];
                linkLines.forEach(l => {
                    const fromNew = idMap[l.from] || l.from;
                    const toNew = idMap[l.to] || l.to;
                    if (idMap[l.from] || idMap[l.to]) newLinkLines.push({ from: fromNew, to: toNew });
                });

                if (newLinkLines.length) linkLines = linkLines.concat(newLinkLines);
                selectedBoxIds = newBoxes.map(b => b.id);
                renderBoxes();
                pushHistory();
            }
            //==================

            function dragSelectedBoxes(e) {
                if (e.detail === 2) return;
                const targets = selectedBoxIds.map(id => boxes.find(b => b.id === id)).filter(b => b);
                if (targets.length === 0) return;

                const startPos = targets.map(b => ({ b, x: b.x, y: b.y }));
                const containerRect = containerArea.getBoundingClientRect(); const startX = e.clientX, startY = e.clientY; let dragging = true;

                const moveHandler = ev => {
                    if (!dragging) return; const dx = ev.clientX - startX; const dy = ev.clientY - startY;
                    startPos.forEach(pos => {
                        let newX = pos.x + dx, newY = pos.y + dy;
                        const boxWidth = pos.b.width, boxHeight = pos.b.height;
                        const maxX = containerRect.width - boxWidth; const maxY = containerRect.height - boxHeight;
                        newX = Math.max(0, Math.min(newX, maxX)); newY = Math.max(0, Math.min(newY, maxY));
                        pos.b.x = newX; pos.b.y = newY;
                    });
                    renderBoxes();
                };
                const upHandler = ev => { dragging = false; document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); pushHistory(); };
                document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
            }

            function resizeBox(div, boxData, e) {
                e.stopPropagation(); const startX = e.clientX, startY = e.clientY; const startW = div.offsetWidth, startH = div.offsetHeight;
                const moveHandler = ev => { let newW = Math.max(50, startW + (ev.clientX - startX)); div.style.width = newW + 'px'; div.style.height = 'auto'; const minTextHeight = div.offsetHeight; let newH = startH + (ev.clientY - startY); newH = Math.max(30, newH, minTextHeight); div.style.height = newH + 'px'; boxData.width = parseInt(div.style.width); boxData.height = parseInt(div.style.height); };
                const upHandler = ev => { document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); pushHistory(); };
                document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
            }


            window.groupSelectedBoxes = function () {
                if (selectedBoxIds.length < 2) return alert("ë¬¶ì„ ë°•ìŠ¤ë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");

                // ê³ ìœ í•œ ê·¸ë£¹ ID ìƒì„±
                const newGroupId = 'g_' + Date.now() + Math.random().toString(16).slice(2);

                let count = 0;
                selectedBoxIds.forEach(id => {
                    const boxData = boxes.find(b => b.id === id);
                    if (boxData) {
                        // ê·¸ë£¹ ID ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
                        if (!boxData.groupIds) boxData.groupIds = [];

                        // êµ¬ë²„ì „(ë¬¸ìì—´ groupId) ë°ì´í„° í˜¸í™˜ ì²˜ë¦¬
                        if (boxData.groupId) {
                            if (!boxData.groupIds.includes(boxData.groupId)) {
                                boxData.groupIds.push(boxData.groupId);
                            }
                            delete boxData.groupId;
                        }

                        // ì´ë¯¸ ê°™ì€ ê·¸ë£¹ì— ì†í•´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                        if (!boxData.groupIds.includes(newGroupId)) {
                            boxData.groupIds.push(newGroupId);
                            count++;
                        }
                    }
                });

                if (count > 0) {
                    renderBoxes();
                    pushHistory();
                    // í”¼ë“œë°±: ë¬¶ê¸° ì™„ë£Œ ì‹œ ì„ íƒëœ ë°•ìŠ¤ë“¤ì˜ í…Œë‘ë¦¬ë¥¼ ì ê¹ ê¹œë¹¡ì„
                    alert(`âœ… ${count}ê°œì˜ ë°•ìŠ¤ê°€ ë¬¶ì˜€ìŠµë‹ˆë‹¤.`);
                }
            };

            window.ungroupSelectedBoxes = function () {
                if (selectedBoxIds.length === 0) return;

                selectedBoxIds.forEach(id => {
                    const boxData = boxes.find(b => b.id === id);
                    if (boxData) {
                        // êµ¬ë²„ì „ í˜¸í™˜ ì²˜ë¦¬
                        if (boxData.groupId && !boxData.groupIds) {
                            boxData.groupIds = [boxData.groupId]; delete boxData.groupId;
                        }

                        // ê°€ì¥ ìµœê·¼ ê·¸ë£¹(ë°°ì—´ì˜ ë§ˆì§€ë§‰) ì œê±°
                        if (boxData.groupIds && boxData.groupIds.length > 0) {
                            boxData.groupIds.pop();
                        }
                    }
                });
                renderBoxes(); pushHistory();
            };

            // [ê¸°ì¡´ ì½”ë“œ ì°¾ê¸°] colors.forEach(c=>{ ... }) ë¶€ë¶„ì˜ sw.onclickì„ ì•„ë˜ë¡œ êµì²´

            colors.forEach(c => {
                const sw = document.createElement('div');
                sw.className = 'color-swatch';
                sw.style.background = c;

                // [â˜… ìˆ˜ì •í•  ì½”ë“œ] í´ë¦­ ì´ë²¤íŠ¸
                sw.onclick = (e) => {
                    // Alt í‚¤ë¥¼ ëˆ„ë¥´ê³  í´ë¦­í•˜ë©´ -> ì„ íƒëœ ë°•ìŠ¤ê°€ ì†í•œ 'ê·¸ë£¹'ì˜ ìƒ‰ ë³€ê²½
                    if (e.altKey) {
                        let changed = false;
                        selectedBoxIds.forEach(id => {
                            const box = boxes.find(b => b.id === id);
                            if (box && box.groupIds) {
                                box.groupIds.forEach(gid => {
                                    groupColors[gid] = c; // ê·¸ë£¹ ìƒ‰ìƒ ì €ì¥
                                    changed = true;
                                });
                            }
                        });
                        if (!changed) alert("ì„ íƒëœ ë°•ìŠ¤ì— ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    // ê·¸ëƒ¥ í´ë¦­í•˜ë©´ -> ë°•ìŠ¤ ìƒ‰ ë³€ê²½ (ê¸°ì¡´ ê¸°ëŠ¥)
                    else {
                        selectedBoxIds.forEach(id => {
                            const boxData = boxes.find(x => x.id == id);
                            if (boxData) boxData.color = c;
                        });
                    }
                    renderBoxes();
                    pushHistory();
                };
                palette.appendChild(sw);
            });




            containerArea.addEventListener('mousedown', (e) => {
                // íœ  ë²„íŠ¼ì´ë‚˜ ìŠ¤í˜ì´ìŠ¤ë°” ëª¨ë“œì¼ ë•ŒëŠ” ë“œë˜ê·¸ ì„ íƒ ë°©ì§€
                if (isHandMode || isSpacePressed || e.button === 1) return;

                if (e.target !== containerArea) return;

                // ì‹œì‘ ì¢Œí‘œ ê³„ì‚°
                const containerRect = containerArea.getBoundingClientRect();
                dragStart = { x: e.clientX - containerRect.left, y: e.clientY - containerRect.top };

                // ì„ íƒ ë°•ìŠ¤ ìƒì„±
                dragSelectRect = document.createElement('div');
                dragSelectRect.style.position = 'absolute';
                dragSelectRect.style.border = '1px dashed #0099ff';
                dragSelectRect.style.background = 'rgba(0,153,255,0.1)';
                dragSelectRect.style.left = dragStart.x + 'px';
                dragSelectRect.style.top = dragStart.y + 'px';
                dragSelectRect.style.zIndex = 999; // ë°•ìŠ¤ë“¤ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡
                dragSelectRect.style.pointerEvents = 'none'; // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ê°€ í†µê³¼ë˜ë„ë¡ ì„¤ì • (ì¤‘ìš”)
                containerArea.appendChild(dragSelectRect);

                const moveHandler = ev => {
                    // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°
                    const currentX = ev.clientX - containerRect.left;
                    const currentY = ev.clientY - containerRect.top;

                    const x = Math.min(currentX, dragStart.x);
                    const y = Math.min(currentY, dragStart.y);
                    const w = Math.abs(currentX - dragStart.x);
                    const h = Math.abs(currentY - dragStart.y);

                    dragSelectRect.style.left = x + 'px';
                    dragSelectRect.style.top = y + 'px';
                    dragSelectRect.style.width = w + 'px';
                    dragSelectRect.style.height = h + 'px';
                };

                const upHandler = ev => {
                    // ë“œë˜ê·¸ ë°•ìŠ¤ì˜ í™”ë©´ìƒ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const selectionRect = dragSelectRect.getBoundingClientRect();

                    // ë„ˆë¬´ ì‘ê²Œ ë“œë˜ê·¸í•œ ê²½ìš°(ë‹¨ìˆœ í´ë¦­) ì„ íƒ ì·¨ì†Œ ë°©ì§€ ë“±ì„ ìœ„í•´ ìµœì†Œ í¬ê¸° ì²´í¬ ê°€ëŠ¥í•˜ë‚˜ ì—¬ê¸°ì„  íŒ¨ìŠ¤

                    // ê¸°ì¡´ ëŒ€ì¥(Master) ê¸°ì–µ
                    const currentMasterId = selectedBoxIds.length > 0 ? selectedBoxIds[0] : null;

                    // ì„ íƒ ëª©ë¡ ì´ˆê¸°í™”
                    selectedBoxIds = [];

                    // í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ ë°•ìŠ¤ë“¤ê³¼ êµì°¨ ê²€ì‚¬
                    boxes.filter(b => b.containerId === activeContainerId).forEach(b => {
                        const boxDiv = containerArea.querySelector(`.box[data-id="${b.id}"]`);
                        if (!boxDiv) return;

                        const boxRect = boxDiv.getBoundingClientRect();

                        // êµì°¨(Overlap) ì²´í¬: ë“œë˜ê·¸ ë°•ìŠ¤ì™€ ë°•ìŠ¤ê°€ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
                        const isOverlap = !(selectionRect.right < boxRect.left ||
                            selectionRect.left > boxRect.right ||
                            selectionRect.bottom < boxRect.top ||
                            selectionRect.top > boxRect.bottom);

                        if (isOverlap) {
                            selectedBoxIds.push(b.id);
                        }
                    });

                    // ì›ë˜ ëŒ€ì¥ì´ ì„ íƒ ë²”ìœ„ì— í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ëŒ€ì¥ ì§€ìœ„ ìœ ì§€
                    if (currentMasterId && selectedBoxIds.includes(currentMasterId)) {
                        selectedBoxIds = selectedBoxIds.filter(id => id !== currentMasterId);
                        selectedBoxIds.unshift(currentMasterId);
                    }

                    renderBoxes();

                    // ë’·ì •ë¦¬
                    if (dragSelectRect) dragSelectRect.remove();
                    dragSelectRect = null;
                    dragStart = null;
                    pushHistory();

                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };

                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            });





            workspace.addEventListener('mousedown', (e) => {
                if (isHandMode || isSpacePressed || e.button === 1) {
                    e.preventDefault(); isPanning = true; panStartX = e.clientX; panStartY = e.clientY; scrollStartX = workspace.scrollLeft; scrollStartY = workspace.scrollTop; workspace.classList.add('grabbing');
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isPanning) return; e.preventDefault(); const dx = e.clientX - panStartX; const dy = e.clientY - panStartY; workspace.scrollLeft = scrollStartX - dx; workspace.scrollTop = scrollStartY - dy;
            });

            window.addEventListener('mouseup', () => { if (isPanning) { isPanning = false; workspace.classList.remove('grabbing'); } });

            function alignSelectedBoxes(mode) {
                if (selectedBoxIds.length < 2) return alert('2ê°œ ì´ìƒì˜ ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                const targets = selectedBoxIds.map(id => boxes.find(b => b.id === id)).filter(b => b);
                if (targets.length === 0) return;
                let minX = Math.min(...targets.map(b => b.x)); let maxX = Math.max(...targets.map(b => b.x + b.width)); let minY = Math.min(...targets.map(b => b.y)); let maxY = Math.max(...targets.map(b => b.y + b.height)); let centerX = (minX + maxX) / 2; let centerY = (minY + maxY) / 2;
                targets.forEach(b => {
                    switch (mode) { case 'left': b.x = minX; break; case 'center': b.x = centerX - (b.width / 2); break; case 'right': b.x = maxX - b.width; break; case 'top': b.y = minY; break; case 'middle': b.y = centerY - (b.height / 2); break; case 'bottom': b.y = maxY - b.height; break; }
                }); renderBoxes(); pushHistory();
            }
            document.getElementById('alignLeftBtn').onclick = () => alignSelectedBoxes('left'); document.getElementById('alignCenterBtn').onclick = () => alignSelectedBoxes('center'); document.getElementById('alignRightBtn').onclick = () => alignSelectedBoxes('right'); document.getElementById('alignTopBtn').onclick = () => alignSelectedBoxes('top'); document.getElementById('alignMiddleBtn').onclick = () => alignSelectedBoxes('middle'); document.getElementById('alignBottomBtn').onclick = () => alignSelectedBoxes('bottom');

            // [â˜… ì¶”ê°€] í˜„ì¬ íƒ­(ì»¨í…Œì´ë„ˆ) ì‚­ì œ ê¸°ëŠ¥
            document.getElementById('deleteContainerBtn').onclick = () => {
                if (!activeContainerId) return alert('ì‚­ì œí•  íƒ­ì´ ì—†ìŠµë‹ˆë‹¤.');
                if (containers.length === 0) return;

                const currentTab = containers.find(c => c.id === activeContainerId);
                if (!confirm(`'${currentTab.name}' íƒ­ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‚´ë¶€ì˜ ëª¨ë“  ë°•ìŠ¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) return;

                // 1. í•´ë‹¹ íƒ­ì— ì†í•œ ë°•ìŠ¤ë“¤ì˜ ID ì°¾ê¸°
                const boxesToRemove = boxes.filter(b => b.containerId === activeContainerId).map(b => b.id);

                // 2. ë°•ìŠ¤ ë° ì—°ê²°ì„  ë°ì´í„° ì‚­ì œ
                boxes = boxes.filter(b => b.containerId !== activeContainerId);
                linkLines = linkLines.filter(l => !boxesToRemove.includes(l.from) && !boxesToRemove.includes(l.to));

                // 3. ì»¨í…Œì´ë„ˆ ë°°ì—´ì—ì„œ ì‚­ì œ
                const idx = containers.findIndex(c => c.id === activeContainerId);
                containers.splice(idx, 1);

                // 4. í™œì„± íƒ­ ì¬ì„¤ì • (ì´ì „ íƒ­ í˜¹ì€ ë‹¤ìŒ íƒ­ìœ¼ë¡œ)
                if (containers.length > 0) {
                    // ì‚­ì œëœ ìœ„ì¹˜ê°€ ë§ˆì§€ë§‰ì´ì—ˆë‹¤ë©´ ê·¸ ì•ì˜ íƒ­ì„, ì•„ë‹ˆë©´ ê·¸ ìë¦¬ì˜ íƒ­ì„ ì„ íƒ
                    const newIdx = Math.min(idx, containers.length - 1);
                    activeContainerId = containers[newIdx].id;
                } else {
                    activeContainerId = null;
                }

                // 5. í™”ë©´ ê°±ì‹  ë° ì €ì¥
                renderTabs();
                renderBoxes();
                pushHistory();
            };


            document.getElementById('addContainerBtn').onclick = () => { const name = prompt('ìƒˆ íƒ­ ì´ë¦„ ì…ë ¥:'); if (name) createContainer(name); };
            document.getElementById('addBoxBtn').onclick = () => { createBox('normal'); };
            document.getElementById('addDotBtn').onclick = () => { createBox('dot'); };
            const bgInput = document.getElementById('bgImageInput');
            document.getElementById('setBgImgBtn').onclick = () => { if (!activeContainerId) return alert('ì»¨í…Œì´ë„ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); bgInput.click(); };
            bgInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { const c = containers.find(x => x.id === activeContainerId); if (c) { c.bgImage = evt.target.result; renderBoxes(); pushHistory(); } }; reader.readAsDataURL(file); e.target.value = ''; };

            document.getElementById('clearBgImgBtn').onclick = () => {
                if (!activeContainerId) return; const c = containers.find(x => x.id === activeContainerId); if (c) { if (!c.bgImage) { alert('ì‚­ì œí•  ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; } if (confirm('ì •ë§ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { c.bgImage = null; renderBoxes(); pushHistory(); } }
            };


            function getTimestamp() {
                const now = new Date();
                return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            }
            // [â˜… ì¶”ê°€ëœ í•¨ìˆ˜: 'single' ë‚´ë³´ë‚´ê¸°, 'all' ì €ì¥, 'saveas' ì²˜ë¦¬]
            async function saveProject(mode) {
                // function saveProject(mode) { ... } ë‚´ë¶€

                // ----------------------------------------------------------------------------------
                // [â˜… ì¶”ê°€í•  ì½”ë“œ: ì„ íƒëœ ë°•ìŠ¤ë§Œ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ë¡œì§]
                // ----------------------------------------------------------------------------------
                if (mode === 'selected') {
                    if (selectedBoxIds.length === 0) {
                        return alert('ë‚´ë³´ë‚¼ ë°•ìŠ¤ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }

                    const currentC = containers.find(x => x.id === activeContainerId);
                    if (!currentC) return alert('í™œì„±í™”ëœ íƒ­ì´ ì—†ìŠµë‹ˆë‹¤.');

                    // 1. ì„ íƒëœ ë°•ìŠ¤ë“¤ í•„í„°ë§
                    const selectedBoxes = boxes.filter(b => selectedBoxIds.includes(b.id));

                    // 2. ì—°ê²°ì„  í•„í„°ë§ (ì„ íƒëœ ë°•ìŠ¤ë“¤ ì‚¬ì´ì˜ ì—°ê²°ì„ ë§Œ)
                    const selectedLines = linkLines.filter(l =>
                        l.from && l.to && selectedBoxIds.includes(l.from) && selectedBoxIds.includes(l.to)
                    );

                    // 3. ê·¸ë£¹ ì •ë³´ ì¶”ì¶œ
                    // ì„ íƒëœ ë°•ìŠ¤ë“¤ì´ í¬í•¨ëœ ê·¸ë£¹ IDë¥¼ ëª¨ë‘ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
                    const uniqueGroupIds = [...new Set(selectedBoxes.flatMap(b => b.groupIds || []))];
                    const selectedGroupColors = {};
                    uniqueGroupIds.forEach(gid => {
                        if (groupColors[gid]) {
                            selectedGroupColors[gid] = groupColors[gid];
                        }
                    });

                    // 4. Export ë°ì´í„° êµ¬ì¡° ìƒì„± (ì»¨í…Œì´ë„ˆëŠ” í˜„ì¬ í™œì„± íƒ­ì˜ ì •ë³´ë¥¼ ì‚¬ìš©)
                    const exportData = {
                        // ì»¨í…Œì´ë„ˆëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ìƒˆ íƒ­ì„ ë§Œë“¤ê¸° ìœ„í•œ í…œí”Œë¦¿ ì—­í• ë§Œ í•©ë‹ˆë‹¤.
                        containers: [currentC],
                        boxes: selectedBoxes,
                        linkLines: selectedLines,
                        activeContainerId: currentC.id, // ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ìƒˆ íƒ­ì´ ì—´ë¦¬ë„ë¡ ì²˜ë¦¬
                        groupColors: selectedGroupColors
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });

                    // íŒŒì¼ ì´ë¦„ ìƒì„±
                    let safeName = (currentC.name || "Tab").replace(/[<>:"/\\|?*]/g, '').trim();
                    if (safeName.length === 0) safeName = `Exported_Selection`;
                    const fileName = `Selection_${safeName}_${getTimestamp()}.json`;

                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    alert(`âœ… [${fileName}] ë‚´ë³´ë‚´ê¸° ì„±ê³µ! (ì„ íƒëœ ë°•ìŠ¤ ${selectedBoxIds.length}ê°œ)`);
                    return;
                }
                // ----------------------------------------------------------------------------------
                // (ì—¬ê¸°ì— ê¸°ì¡´ 'single' ëª¨ë“œ ë¡œì§ì´ ì´ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.)
                // else if (mode === 'single') { ... }
                if (!activeContainerId && mode !== 'all' && mode !== 'saveas') {
                    return alert('í™œì„±í™”ëœ íƒ­ì´ ì—†ìŠµë‹ˆë‹¤.');
                }

                // 'single' ëª¨ë“œ: í˜„ì¬ íƒ­ì˜ ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ ë‹¤ìš´ë¡œë“œ
                if (mode === 'single') {
                    const c = containers.find(x => x.id === activeContainerId);
                    if (!c) return;

                    const currentBoxes = boxes.filter(b => b.containerId === c.id);
                    const ids = currentBoxes.map(b => b.id);
                    const lines = linkLines.filter(l => l.from && l.to && ids.includes(l.from) && ids.includes(l.to));

                    // ë‚´ë³´ë‚¼ ë°ì´í„°: ì»¨í…Œì´ë„ˆ, ë°•ìŠ¤, ì—°ê²°ì„ , ê·¸ë£¹ ìƒ‰ìƒ í¬í•¨
                    const exportData = {
                        containers: [c],
                        boxes: currentBoxes,
                        linkLines: lines,
                        activeContainerId: c.id,
                        groupColors: groupColors // ê·¸ë£¹ ìƒ‰ìƒ ë°ì´í„° í¬í•¨
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });

                    let safeName = (c.name || "Tab").replace(/[<>:"/\\|?*]/g, '').trim();
                    if (safeName.length === 0) safeName = `Exported_Tab`;
                    const fileName = `${safeName}_${getTimestamp()}.json`;

                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    alert(`âœ… [${fileName}] ë‚´ë³´ë‚´ê¸° ì„±ê³µ! (í˜„ì¬ íƒ­ ë°ì´í„°)`);
                    return;
                }
                // 'all' ë˜ëŠ” 'saveas'ëŠ” smartSaveë¥¼ í†µí•´ íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                else if (mode === 'all' || mode === 'saveas') {
                    await saveProjectSmart(mode === 'saveas');
                }
                // 'folder' ëª¨ë“œëŠ” ê¸°ì¡´ ì½”ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (Snippet 19 ì°¸ì¡°)
                else if (mode === 'folder') {
                    if (containers.length === 0) return alert('íƒ­ ì—†ìŒ');
                    if (!window.showDirectoryPicker) return alert("PC í¬ë¡¬/ì—£ì§€ ë¸Œë¼ìš°ì € í•„ìš”");
                    // ... (ê¸°ì¡´ í´ë” ë°±ì—… ë¡œì§)
                    // [íŒŒì¼ì´ ë¶ˆì™„ì „í•˜ë¯€ë¡œ ê¸°ì¡´ ë¡œì§ì€ ì—¬ê¸°ì— ìƒëµí•˜ê³ , ì›ë³¸ íŒŒì¼ì˜ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•¨]
                    alert("í´ë” ì €ì¥ ê¸°ëŠ¥ì€ ì›ë³¸ íŒŒì¼ì˜ ê¸°ì¡´ ë¡œì§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                }
            }


            document.getElementById('openProjectBtn').onclick = async () => {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Project', accept: { 'application/json': ['.json'] } }], multiple: false });
                    currentFileHandle = fileHandle; const file = await fileHandle.getFile(); const contents = await file.text();
                    loadProjectData(contents);
                    currentFileNameSpan.textContent = "ğŸ“„ " + file.name; currentFileNameSpan.style.display = "inline-block";
                    alert(`âœ… [${file.name}] ì—´ê¸° ì„±ê³µ!\nì´ì œ Ctrl+Së¥¼ ëˆ„ë¥´ë©´ ì´ íŒŒì¼ì— ë°”ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`);
                } catch (err) { if (err.name !== 'AbortError') alert("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: " + err.message); }
            };



            //=============
            function loadProjectData(jsonString) {
                try {
                    // 1. ì—¬ê¸°ì„œ 'data'ë¼ëŠ” ë³€ìˆ˜ê°€ ë¹„ë¡œì†Œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.
                    const data = JSON.parse(jsonString);

                    if (!data.containers) throw new Error("ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜");

                    containers = data.containers;
                    boxes = data.boxes || [];
                    linkLines = data.linkLines || [];
                    activeContainerId = data.activeContainerId || (containers[0] ? containers[0].id : null);

                    // [â˜… ìˆ˜ì •í•  ìœ„ì¹˜] ë°˜ë“œì‹œ 'data'ê°€ ì •ì˜ëœ ì´ ì•„ë«ë¶€ë¶„ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
                    // ê¸°ì¡´ íŒŒì¼ì—ëŠ” groupColorsê°€ ì—†ìœ¼ë¯€ë¡œ, ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´({})ë¥¼ ì“°ë„ë¡ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                    groupColors = data.groupColors || {};

                    renderTabs();
                    renderBoxes();
                    pushHistory();
                } catch (err) {
                    // ì´ alertê°€ ëœ¨ì§€ ì•Šê³  ë°”ê¹¥ì˜ catchê°€ ì¡ì•„ì„œ "íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨"ê°€ ë–´ë˜ ê²ƒì…ë‹ˆë‹¤.
                    alert('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ' + err.message);
                }
            }


            document.getElementById('executeSaveBtn').onclick = async () => {
                const mode = document.getElementById('saveModeSelect').value;
                await saveProject(mode);
                if (mode === 'all') { await saveProjectSmart(); }
                else if (mode === 'saveas') { await saveProjectAs(); }
                else if (mode === 'single') {
                    if (!activeContainerId) return alert('íƒ­ ì—†ìŒ'); const c = containers.find(x => x.id === activeContainerId); const currentBoxes = boxes.filter(b => b.containerId === activeContainerId); const ids = currentBoxes.map(b => b.id); const lines = linkLines.filter(l => ids.includes(l.from) && ids.includes(l.to)); const data = { containers: [c], boxes: currentBoxes, linkLines: lines, activeContainerId: activeContainerId }; const safeName = (c.name || "Tab").replace(/[<>:"/\\|?*]/g, '').trim(); downloadFile(`${getTimestamp()}_${safeName}.json`, JSON.stringify(data, null, 2));
                }
                else if (mode === 'folder') {
                    if (containers.length === 0) return alert('íƒ­ ì—†ìŒ'); if (!window.showDirectoryPicker) return alert("PC í¬ë¡¬/ì—£ì§€ ë¸Œë¼ìš°ì € í•„ìš”");
                    try { const dirHandle = await window.showDirectoryPicker(); const folderName = `${getTimestamp()}_Tabs`; const newDirHandle = await dirHandle.getDirectoryHandle(folderName, { create: true }); for (let i = 0; i < containers.length; i++) { const c = containers[i]; const currentBoxes = boxes.filter(b => b.containerId === c.id); const ids = currentBoxes.map(b => b.id); const lines = linkLines.filter(l => l.from && l.to && ids.includes(l.from) && ids.includes(l.to)); const data = { containers: [c], boxes: currentBoxes, linkLines: lines, activeContainerId: c.id }; let safeName = (c.name || "Tab").replace(/[<>:"/\\|?*]/g, '').trim(); if (safeName.length === 0) safeName = `Tab_${i + 1}`; const fileName = `${safeName}.json`; const fileHandle = await newDirHandle.getFileHandle(fileName, { create: true }); const writable = await fileHandle.createWritable(); await writable.write(JSON.stringify(data, null, 2)); await writable.close(); } alert(`âœ… [${folderName}] ì €ì¥ ì™„ë£Œ`); } catch (err) { if (err.name !== 'AbortError') alert("ì˜¤ë¥˜: " + err.message); }
                }
            };

            async function saveProjectSmart(forceSaveAs = false) {
                const dataStr = JSON.stringify({ containers, boxes, linkLines, activeContainerId, groupColors }, null, 2);
                if (currentFileHandle) {
                    try {
                        const writable = await currentFileHandle.createWritable(); await writable.write(dataStr); await writable.close();
                        autoSaveMsg.textContent = "ğŸ’¾ ì €ì¥ ì™„ë£Œ!"; autoSaveMsg.style.display = 'block'; setTimeout(() => { autoSaveMsg.style.display = 'none'; }, 2000);
                    } catch (err) { alert("ì €ì¥ ì‹¤íŒ¨: " + err.message); }
                } else { await saveProjectAs(); }
            }

            // ì¶”ê°€

            //ì¶”ê°€ ë






            async function saveProjectAs() {
                const dataStr = JSON.stringify({ containers, boxes, linkLines, activeContainerId, groupColors }, null, 2);

                try {
                    const options = { suggestedName: `${getTimestamp()}_Project.json`, types: [{ description: 'JSON Project', accept: { 'application/json': ['.json'] } }] };
                    const handle = await window.showSaveFilePicker(options); currentFileHandle = handle;
                    const writable = await handle.createWritable(); await writable.write(dataStr); await writable.close();
                    const file = await handle.getFile(); currentFileNameSpan.textContent = "ğŸ“„ " + file.name; currentFileNameSpan.style.display = "inline-block"; alert(`âœ… [${file.name}] ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (err) { if (err.name !== 'AbortError') alert("ì €ì¥ ì·¨ì†Œ/ì‹¤íŒ¨"); }
            }

            function downloadFile(filename, content) { const blob = new Blob([content], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

            document.getElementById('resetDataBtn').onclick = () => { if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { containers = []; boxes = []; linkLines = []; activeContainerId = null; selectedBoxIds = []; currentFileHandle = null; currentFileNameSpan.style.display = 'none'; localStorage.removeItem(STORAGE_KEY); document.querySelectorAll('.linkLine').forEach(el => el.remove()); document.querySelectorAll('.group-rect').forEach(el => el.remove()); renderTabs(); renderBoxes(); } };
            document.getElementById('importBtn').onclick = () => { document.getElementById('importFile').click(); };




            document.getElementById('importFile').onchange = ev => {
                const file = ev.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.containers || !data.boxes) throw new Error("í”„ë¡œì íŠ¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                        const idMap = {}; // ëª¨ë“  IDë¥¼ ë§µí•‘í•  ê°ì²´

                        // 1. ì»¨í…Œì´ë„ˆ(íƒ­) ID ì¬í• ë‹¹ ë° ë°•ìŠ¤ ì—°ê²°
                        if (data.containers.length > 0) {
                            const oldCid = data.containers[0].id;
                            // ìƒˆë¡œìš´ ê³ ìœ  ID ìƒì„±
                            const newCid = 'c' + Date.now() + Math.random().toString(16).slice(2);
                            idMap[oldCid] = newCid;
                            data.containers[0].id = newCid; // ì»¨í…Œì´ë„ˆ ê°ì²´ ID ì—…ë°ì´íŠ¸

                            // í•´ë‹¹ ì»¨í…Œì´ë„ˆì˜ ëª¨ë“  ë°•ìŠ¤ê°€ ìƒˆ ì»¨í…Œì´ë„ˆ IDë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì—…ë°ì´íŠ¸
                            data.boxes.forEach(b => {
                                // Export íŒŒì¼ì€ í•˜ë‚˜ì˜ íƒ­ë§Œ í¬í•¨í•˜ë¯€ë¡œ, ë°•ìŠ¤ë“¤ì€ ì´ ì»¨í…Œì´ë„ˆ IDë¥¼ ê°€ì§ˆ ê²ƒì…ë‹ˆë‹¤.
                                if (b.containerId === oldCid) {
                                    b.containerId = newCid;
                                }
                            });
                        }

                        // 2. ë°•ìŠ¤ ë° ê·¸ë£¹ ID ì¬í• ë‹¹
                        if (data.boxes) data.boxes.forEach(b => {
                            const newId = 'b' + Date.now() + Math.random().toString(16).slice(2);
                            idMap[b.id] = newId;
                            b.id = newId;

                            // ê·¸ë£¹ ID ì¬í• ë‹¹ ë° ë§µí•‘
                            if (b.groupIds && b.groupIds.length > 0) {
                                b.groupIds = b.groupIds.map(oldGid => {
                                    if (!idMap[oldGid]) {
                                        const newGid = 'g_' + Date.now() + Math.random().toString(16).slice(2);
                                        idMap[oldGid] = newGid;
                                    }
                                    return idMap[oldGid];
                                });
                            }
                        });

                        // 3. ì—°ê²°ì„  ID ì—…ë°ì´íŠ¸
                        const newLines = data.linkLines
                            .filter(l => l.from && l.to && idMap[l.from] && idMap[l.to]) // ìœ íš¨í•œ ì—°ê²°ì„ ë§Œ í•„í„°ë§
                            .map(l => ({ ...l, from: idMap[l.from], to: idMap[l.to] }));

                        // 4. ê·¸ë£¹ ìƒ‰ìƒ ë°ì´í„° ë³‘í•© (ìƒˆ ê·¸ë£¹ ID ì‚¬ìš©)
                        if (data.groupColors) {
                            Object.keys(data.groupColors).forEach(oldGid => {
                                const newGid = idMap[oldGid];
                                // ìƒˆë¡œìš´ ê·¸ë£¹ IDê°€ ìˆê³ , ê¸°ì¡´ í”„ë¡œì íŠ¸ì— ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                                if (newGid && !groupColors[newGid]) {
                                    groupColors[newGid] = data.groupColors[oldGid];
                                }
                            });
                        }

                        // 5. ìµœì¢… ë°ì´í„° ë³‘í•© (ì¤‘ë³µëœ .concat() ì œê±°)
                        containers.push(...data.containers);
                        boxes.push(...data.boxes);
                        linkLines.push(...newLines);

                        // í™œì„± ì»¨í…Œì´ë„ˆë¥¼ ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì˜ ì²« ë²ˆì§¸ íƒ­(ìƒˆ ID)ìœ¼ë¡œ ì „í™˜
                        activeContainerId = data.containers[0].id;

                        renderTabs();
                        renderBoxes();
                        pushHistory();
                        alert('âœ… ë°ì´í„° í•©ì¹˜ê¸° ì™„ë£Œ! (ê·¸ë£¹ ìƒ‰ìƒ ë° ID ì¶©ëŒ í•´ê²°)');

                    } catch (err) {
                        alert('âŒ ì˜¤ë¥˜: ' + err.message);
                    }
                };
                reader.readAsText(file);
                ev.target.value = '';
            };
            //ë
            //





            document.getElementById('exportPNG').onclick = () => {
                if (!activeContainerId) return alert('íƒ­ ì„ íƒ í•„ìš”');
                const activeContainer = containers.find(c => c.id === activeContainerId);
                if (!activeContainer) return;

                const safeName = (activeContainer.name || "Map").replace(/[<>:"/\\|?*]/g, '').trim();

                // [ìˆ˜ì •] scale: 3 ì˜µì…˜ ì¶”ê°€ (ì¸ì‡„ í’ˆì§ˆ í–¥ìƒ í•µì‹¬)
                const scaleFactor = 3;

                html2canvas(containerArea, {
                    allowTaint: true,
                    useCORS: true,
                    scale: scaleFactor // í•´ìƒë„ë¥¼ 3ë°°ë¡œ ë†’ì„
                }).then(canvas => {
                    // ì—¬ë°±ë„ í•´ìƒë„ ë¹„ìœ¨ì— ë§ì¶° ëŠ˜ë ¤ì¤Œ (ê¸°ë³¸ 60px * 3 = 180px)
                    const padding = 60 * scaleFactor;

                    const newCanvas = document.createElement('canvas');
                    newCanvas.width = canvas.width + padding * 2;
                    newCanvas.height = canvas.height + padding * 2;
                    const ctx = newCanvas.getContext('2d');

                    // ë°°ê²½ í°ìƒ‰ ì±„ìš°ê¸°
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);

                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(canvas, padding, padding);

                    // ë‹¤ìš´ë¡œë“œ
                    const a = document.createElement('a');
                    // PNG í’ˆì§ˆ í–¥ìƒ
                    a.href = newCanvas.toDataURL('image/png', 1.0);
                    a.download = `${safeName}.png`;
                    a.click();
                });
            };



            document.getElementById('helpBtn').onclick = () => { document.getElementById('helpModal').style.display = 'flex'; };
            document.getElementById('closeHelp').onclick = () => { document.getElementById('helpModal').style.display = 'none'; };

        
            document.addEventListener('keydown', e => {
                if (e.repeat) return;
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                const key = e.key.toLowerCase(); const code = e.code; const ctrl = e.ctrlKey || e.metaKey; const shift = e.shiftKey;
                if (code === 'Space') { isSpacePressed = true; workspace.classList.add('grab'); }
                if (ctrl && (key === 's' || code === 'KeyS' || key === 'ã„´')) { e.preventDefault(); saveProjectSmart(); return; }
                if (ctrl && !shift && (key === 'z' || code === 'KeyZ' || key === 'ã…‹')) { e.preventDefault(); undo(); return; }
                if (ctrl && (key === 'y' || code === 'KeyY' || (shift && (key === 'z' || code === 'KeyZ')))) { e.preventDefault(); redo(); return; }

                // [ë³µì œ ê¸°ëŠ¥]
                if (ctrl && (key === 'd' || code === 'KeyD')) { e.preventDefault(); cloneSelectedBoxes(); return; }

                if (ctrl && (key === 'b' || code === 'KeyB' || key === 'ã… ')) { e.preventDefault(); if (selectionHistoryStack.length === 0) return; const idsToRestore = selectionHistoryStack.pop(); selectedBoxIds = idsToRestore; renderBoxes(); return; }
                if (code === 'Delete' || key === 'delete') { e.preventDefault(); if (selectedBoxIds.length === 0) return; boxes = boxes.filter(b => !selectedBoxIds.includes(b.id)); linkLines = linkLines.filter(l => !selectedBoxIds.includes(l.from) && !selectedBoxIds.includes(l.to)); selectedBoxIds = []; renderBoxes(); pushHistory(); }
            });



            document.addEventListener('keyup', e => {
                if (e.code === 'Space') { isSpacePressed = false; if (!isHandMode) workspace.classList.remove('grab'); }
            });

            window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = ''; });

            // ìŠ¤í¬ë¦½íŠ¸ ì•„ë¬´ ê³³ì—ë‚˜ ì¶”ê°€ (ì˜ˆ: window.groupSelectedBoxes í•¨ìˆ˜ ê·¼ì²˜)
            window.setTextAlign = function (alignMode) {
                if (selectedBoxIds.length === 0) return alert("ê¸€ì ì •ë ¬ì„ ë³€ê²½í•  ë°•ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

                selectedBoxIds.forEach(id => {
                    const box = boxes.find(b => b.id === id);
                    if (box) {
                        box.textAlign = alignMode;
                    }
                });
                renderBoxes();
                pushHistory(); // ì‹¤í–‰ ì·¨ì†Œ(Ctrl+Z)ë¥¼ ìœ„í•´ ê¸°ë¡ ì €ì¥
            };


            loadFromLocalStorage(); renderTabs(); renderBoxes();


            // [â˜… ì¶”ê°€í•  ì½”ë“œ] HEX ìƒ‰ìƒì„ RGBA(íˆ¬ëª…ë„ í¬í•¨)ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function hexToRgba(hex, alpha) {
                let c;
                if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                    c = hex.substring(1).split('');
                    if (c.length == 3) {
                        c = [c[0], c[0], c[1], c[1], c[2], c[2]];
                    }
                    c = '0x' + c.join('');
                    return 'rgba(' + [(c >> 16) & 255, (c >> 8) & 255, c & 255].join(',') + ',' + alpha + ')';
                }
                return hex; // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            }

        });


    </script>
</body>

</html>